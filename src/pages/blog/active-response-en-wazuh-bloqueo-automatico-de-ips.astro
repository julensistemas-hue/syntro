---
import BlogLayout from "../../layouts/BlogLayout.astro";
---

<BlogLayout
  title="Active Response en Wazuh: Bloqueo automático de IPs"
  description="Active Response en Wazuh: Bloqueo automático de IPs: Guía práctica para implementación empresarial en Wazuh"
  publishDate="2025-12-03"
  author="AI Security"
  readTime="8 min"
  tags={["active response", "firewall", "iptables", "automatic blocking", "Wazuh", "Ciberseguridad"]}
  canonical="https://aisecurity.es/blog/active-response-en-wazuh-bloqueo-automatico-de-ips">

```html
<p>Los ataques de fuerza bruta contra servicios expuestos como SSH son una amenaza constante. La respuesta activa (<strong>active response</strong>) de Wazuh permite automatizar la defensa, bloqueando direcciones IP de atacantes directamente en el <strong>firewall</strong> del sistema afectado, reduciendo drásticamente la superficie de ataque sin intervención manual.</p>

<h2>Caso de uso empresarial: Protección de servidores SSH</h2>
<p>Una empresa de desarrollo de software mantiene servidores Linux en la nube para sus equipos. El puerto 22 (SSH) está abierto a Internet para permitir el acceso remoto de los administradores. Diariamente, los logs de autenticación registran miles de intentos de inicio de sesión fallidos desde IPs de todo el mundo. Este bombardeo constante no solo consume recursos del servidor, sino que también presenta un riesgo de seguridad si una contraseña débil es descubierta. El equipo de TI necesita una solución que bloquee automáticamente estas IPs maliciosas tras un número determinado de intentos fallidos.</p>

<h2>Requisitos previos</h2>
<ul>
    <li>Un Wazuh Manager instalado y operativo.</li>
    <li>Un Agente de Wazuh instalado en el servidor Linux que se desea proteger.</li>
    <li>El agente debe estar conectado y reportando al manager.</li>
    <li>Privilegios de administrador (root/sudo) tanto en el Manager como en el Agente.</li>
    <li>El servicio <strong>iptables</strong> debe estar instalado y en uso en la máquina del Agente.</li>
</ul>

<h2>Instalación y Configuración</h2>
<p>La configuración se realiza centralmente en el Wazuh Manager. El manager enviará la orden de bloqueo al agente correspondiente cuando se cumplan las condiciones definidas.</p>

<ol>
    <li>
        <p><strong>Definir el comando de Active Response en el Wazuh Manager</strong></p>
        <p>Añade el siguiente bloque al fichero de configuración del manager, ubicado en <code>/var/ossec/etc/ossec.conf</code>. Este bloque define el comando <code>firewall-drop</code>, que utiliza el script por defecto de Wazuh para interactuar con firewalls locales. El script es inteligente y funciona con iptables, ipfilter y otros.</p>
        <pre><code class="language-bash">&lt;command&gt;
  &lt;name&gt;firewall-drop&lt;/name&gt;
  &lt;executable&gt;firewall-drop.sh&lt;/executable&gt;
  &lt;timeout_allowed&gt;yes&lt;/timeout_allowed&gt;
&lt;/command&gt;</code></pre>
    </li>
    <li>
        <p><strong>Crear la regla de Active Response</strong></p>
        <p>Ahora, en el mismo fichero <code>ossec.conf</code> del manager, añade el bloque <code>&lt;active-response&gt;</code>. Esta configuración le dice a Wazuh que ejecute el comando <code>firewall-drop</code> cuando se dispare la regla <strong>5712</strong> (Múltiples fallos de autenticación SSH). El bloqueo durará 600 segundos (10 minutos).</p>
        <pre><code class="language-bash">&lt;active-response&gt;
  &lt;command&gt;firewall-drop&lt;/command&gt;
  &lt;location&gt;local&lt;/location&gt;
  &lt;rules_id&gt;5712&lt;/rules_id&gt;
  &lt;timeout&gt;600&lt;/timeout&gt;
&lt;/active-response&gt;</code></pre>
        <p><strong>Explicación de los parámetros:</strong></p>
        <ul>
            <li><strong>command:</strong> El comando a ejecutar, que definimos en el paso anterior.</li>
            <li><strong>location:</strong> <code>local</code> significa que el script se ejecutará en el agente que generó la alerta.</li>
            <li><strong>rules_id:</strong> El ID de la regla que activará la respuesta. La regla 5712 es específica para múltiples fallos de SSH.</li>
            <li><strong>timeout:</strong> Duración del bloqueo en segundos. Tras este tiempo, la IP se eliminará automáticamente de la regla de <strong>iptables</strong>.</li>
        </ul>
    </li>
    <li>
        <p><strong>Reiniciar el Wazuh Manager</strong></p>
        <p>Para aplicar los cambios, reinicia el servicio del manager.</p>
        <pre><code class="language-bash">sudo systemctl restart wazuh-manager</code></pre>
    </li>
     <li>
        <p><strong>Verificar la configuración del Agente</strong></p>
        <p>Por defecto, los agentes de Wazuh tienen el módulo `wodle` para ejecutar comandos remotos (Active Response) habilitado. Asegúrate de que el bloque siguiente está presente y no deshabilitado en el fichero <code>/var/ossec/etc/ossec.conf</code> del agente.</p>
        <pre><code class="language-bash">&lt;ossec_config&gt;
  &lt;wodle name="command"&gt;
    &lt;disabled&gt;no&lt;/disabled&gt;
    &lt;tag&gt;remote_commands&lt;/tag&gt;
    &lt;log_path&gt;/var/ossec/logs/active-responses.log&lt;/log_path&gt;
  &lt;/wodle&gt;
&lt;/ossec_config&gt;</code></pre>
        <p>Si realizas algún cambio, reinicia el agente con <code>sudo systemctl restart wazuh-agent</code>.</p>
    </li>
</ol>

<h2>Ejemplo práctico</h2>
<p>Vamos a simular un ataque de fuerza bruta para probar nuestra configuración.</p>

<ol>
    <li>
        <p><strong>Simular el ataque</strong></p>
        <p>Desde una máquina externa (con IP, por ejemplo, <code>198.51.100.10</code>), intenta conectarte por SSH al servidor protegido varias veces con un usuario y contraseña incorrectos. Wazuh requiere varios fallos en un corto periodo de tiempo para activar la regla 5712.</p>
        <pre><code class="language-bash"># Repite este comando 5-6 veces desde la IP del atacante
ssh usuario_falso@IP_DEL_SERVIDOR_PROTEGIDO</code></pre>
    </li>
    <li>
        <p><strong>Verificar el bloqueo en el servidor protegido (Agente)</strong></p>
        <p>Conéctate al servidor protegido (desde una IP autorizada o la consola) y comprueba las reglas de <strong>iptables</strong>. Deberías ver una nueva regla que bloquea la IP del atacante.</p>
        <pre><code class="language-bash">sudo iptables -L INPUT -n --line-numbers</code></pre>
    </li>
    <li>
        <p><strong>Output esperado</strong></p>
        <p>El resultado del comando anterior debería mostrar la IP del atacante (<code>198.51.100.10</code>) en una regla de tipo <code>DROP</code>.</p>
        <pre><code class="language-bash">Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination
1    DROP       all  --  198.51.100.10        0.0.0.0/0</code></pre>
        <p>Esto confirma que el <strong>automatic blocking</strong> está funcionando. Cualquier conexión futura desde esa IP será descartada por el firewall.</p>
    </li>
    <li>
        <p><strong>Revisar las alertas en Wazuh</strong></p>
        <p>En la interfaz de Wazuh o directamente en los logs del manager (<code>/var/ossec/logs/alerts/alerts.json</code>), verás una alerta para la regla 5712, seguida de una alerta informativa (regla 602) que confirma la ejecución de la respuesta activa.</p>
    </li>
</ol>

<h2>Automatización conseguida</h2>
<p>Has implementado con éxito una defensa proactiva y automatizada. La respuesta activa de Wazuh ahora protege tu servidor SSH bloqueando a los atacantes en tiempo real, fortaleciendo tu infraestructura y liberando tiempo valioso del equipo de operaciones de seguridad. Esta misma lógica se puede aplicar para proteger otros servicios como RDP, bases de datos o aplicaciones web.</p>
<p>Si necesitas implementar soluciones de seguridad personalizadas o auditar tu infraestructura con expertos, agenda una reunión con nuestro equipo en /reunion.</p>
```

  <hr />

  <p class="text-sm text-base-600">
    <strong>¿Necesitas implementar esta solución?</strong> <a href="/reunion">Solicita una consulta gratuita aquí</a>.
  </p>
</BlogLayout>
