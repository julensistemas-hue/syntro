---
import BlogLayout from "../../layouts/BlogLayout.astro";
---

<BlogLayout
  title="Integración de Wazuh con MISP para Threat Intelligence"
  description="Integración de Wazuh con MISP para Threat Intelligence: Guía práctica para implementación empresarial en Wazuh"
  publishDate="2025-12-03"
  author="AI Security"
  readTime="8 min"
  tags={["MISP", "threat intelligence", "IOC", "indicators of compromise", "Wazuh", "Ciberseguridad"]}
  canonical="https://aisecurity.es/blog/integracion-de-wazuh-con-misp-para-threat-intelligence">

<p>Las organizaciones modernas enfrentan un diluvio constante de amenazas. La integración efectiva de <strong>Wazuh</strong> con sistemas de <strong>Threat Intelligence</strong> como <strong>MISP</strong> es crucial para una defensa proactiva. Esta guía detalla cómo automatizar la ingestión de <strong>IOCs</strong> (Indicators of Compromise) de MISP a Wazuh para una detección inmediata y una respuesta acelerada.</p>

<h2>Caso de uso empresarial</h2>
<p>Una empresa del sector financiero es un objetivo recurrente de ataques de phishing y ransomware. Reciben constantemente nuevas listas de hashes de archivos maliciosos, direcciones IP de comando y control (C2) y dominios de phishing de fuentes de inteligencia de amenazas. Actualizar manualmente las listas de bloqueo o las reglas de detección en sus sistemas de seguridad es lento y propenso a errores, dejando ventanas de vulnerabilidad. La integración de MISP con Wazuh permite que, tan pronto como un nuevo IOC se registra en MISP, Wazuh sea capaz de detectarlo automáticamente en sus puntos finales y servidores, minimizando el tiempo de exposición a nuevas amenazas.</p>

<h2>Requisitos previos</h2>
<ul>
    <li>Un <strong>Wazuh Manager</strong> (v4.x o superior) operativo.</li>
    <li>Una instancia de <strong>MISP</strong> (v2.4 o superior) operativa con acceso API habilitado.</li>
    <li><strong>Python 3</strong> instalado en el Wazuh Manager.</li>
    <li>Conectividad de red entre el Wazuh Manager y la instancia de MISP.</li>
</ul>

<h2>Instalación/Configuración</h2>

<h3>1. Instalar dependencias en Wazuh Manager</h3>
<p>Necesitamos el cliente Python para interactuar con la API de MISP.</p>
<pre><code class="language-bash">pip3 install pymisp
</code></pre>
<p>Este comando instala la biblioteca <code>pymisp</code>, que facilita la comunicación con la API de MISP.</p>

<h3>2. Crear script de sincronización MISP</h3>
<p>Cree un script Python en su Wazuh Manager que descargue los IOCs de MISP y los formateé para una lista CDB de Wazuh. Guarde este archivo como <code>/var/ossec/integrations/sync_misp_iocs.py</code>.</p>
<pre><code class="language-python">import os
import sys
import json
from pymisp import PyMISP
from datetime import datetime, timedelta

# --- CONFIGURACIÓN ---
MISP_URL = os.getenv("MISP_URL", "https://your-misp-instance.com")
MISP_KEY = os.getenv("MISP_KEY", "YOUR_MISP_API_KEY") # Obtén esto de tu perfil MISP
MISP_VERIFY_SSL = os.getenv("MISP_VERIFY_SSL", "True").lower() == "true"
Wazuh_CDB_PATH = "/var/ossec/etc/lists/misp_iocs.cdb"

# Tipos de atributos de MISP que queremos importar como IOCs
IOC_TYPES = [
    "md5", "sha1", "sha256", "filename|md5", "filename|sha1", "filename|sha256",
    "ip-src", "ip-dst", "domain", "url"
]
# --- FIN CONFIGURACIÓN ---

def get_misp_iocs():
    misp = PyMISP(MISP_URL, MISP_KEY, MISP_VERIFY_SSL)
    iocs = set()

    # Obtener eventos de los últimos 7 días. Ajusta según necesidad.
    # Puedes usar tags, IDs de eventos específicos, etc.
    # Ejemplo: Filtrar por tag 'ransomware'
    # events = misp.search(tags='ransomware', date_from=(datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d'))
    
    # Para este ejemplo, buscaremos atributos directos sin filtrar por evento
    # Esto puede ser muy amplio, considera usar misp.search('events', date_from=...) para eventos específicos
    
    # Buscar atributos directamente. Esto puede ser ineficiente para instancias MISP grandes.
    # Es preferible buscar eventos y luego iterar sus atributos.
    # Para un entorno productivo, se recomienda buscar por 'events' con filtros de fecha o tags.

    try:
        # Una forma más robusta: buscar eventos recientes y luego extraer atributos
        # Esto reduce la carga si MISP es grande.
        # Busca eventos publicados en los últimos 30 días
        # y que no tengan un tag como 'deprecated', 'analysed', etc.
        events = misp.search(controller='events', date_from=(datetime.now() - timedelta(days=30)).strftime('%Y-%m-%d'), published='true', enforce_warning_list=True)

        if not events:
            print("No se encontraron eventos recientes en MISP.")
            return iocs

        for event in events:
            if 'Attribute' in event:
                for attribute in event['Attribute']:
                    if attribute['type'] in IOC_TYPES and not attribute['deleted']:
                        value = attribute['value'].strip()
                        if value:
                            iocs.add(value)
    except Exception as e:
        print(f"Error al conectar con MISP o al obtener IOCs: {e}")
        sys.exit(1)
        
    return iocs

def write_cdb_list(iocs_set):
    try:
        with open(Wazuh_CDB_PATH, 'w') as f:
            for ioc in sorted(list(iocs_set)):
                f.write(f"{ioc}:1\n") # Wazuh CDB Key:Value
        print(f"Lista CDB de IOCs actualizada en {Wazuh_CDB_PATH} con {len(iocs_set)} entradas.")
    except Exception as e:
        print(f"Error al escribir el archivo CDB: {e}")
        sys.exit(1)

if __name__ == "__main__":
    print("Iniciando sincronización de IOCs de MISP con Wazuh...")
    iocs = get_misp_iocs()
    if iocs:
        write_cdb_list(iocs)
    else:
        print("No se encontraron IOCs para escribir.")
</code></pre>
<p>Este script se conecta a su instancia de MISP, recupera los atributos de ciertos tipos (MD5, SHA, IP, Dominio) de eventos recientes y los escribe en un archivo CDB en el formato <code>IOC_VALOR:1</code>.</p>
<p><strong>Notas de seguridad:</strong> No incruste la clave API de MISP directamente en el script. Utilice variables de entorno (como se muestra en el ejemplo) o un archivo de configuración separado para gestionar credenciales de forma segura.</p>

<h3>3. Configurar Wazuh para usar los IOCs</h3>
<p>Edite <code>/var/ossec/etc/ossec.conf</code> para incluir la nueva lista CDB y un archivo de reglas personalizado.</p>
<pre><code class="language-xml">&lt;ossec_config&gt;
  ...
  &lt;!-- Archivos de listas externas --&gt;
  &lt;lists&gt;
    &lt;list synchronize="yes"&gt;etc/lists/misp_iocs.cdb&lt;/list&gt;
  &lt;/lists&gt;

  &lt;!-- Reglas locales personalizadas --&gt;
  &lt;local_rules&gt;
    &lt;rule_dir&gt;rules&lt;/rule_dir&gt;
    &lt;rule_file&gt;local_rules.xml&lt;/rule_file&gt;
    &lt;rule_file&gt;rules/local_misp.xml&lt;/rule_file&gt; &lt;!-- Nuevo archivo de reglas --&gt;
  &lt;/local_rules&gt;
  ...
&lt;/ossec_config&gt;
</code></pre>
<p>A continuación, cree el archivo de reglas <code>/var/ossec/etc/rules/local_misp.xml</code>:</p>
<pre><code class="language-xml">&lt;group name="syslog,misp,"&gt;

  &lt;!-- Regla base para IOCs de MISP --&gt;
  &lt;rule id="100001" level="7"&gt;
    &lt;if_sid&gt;5&lt;/if_sid&gt; &lt;!-- Cualquier evento que genere un log --&gt;
    &lt;description&gt;MISP IOC Detected.&lt;/description&gt;
    &lt;group&gt;misp_ioc_detected,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;!-- Detección de Hashes de archivo --&gt;
  &lt;rule id="100002" level="10"&gt;
    &lt;if_sid&gt;100001&lt;/if_sid&gt;
    &lt;field name="win.eventdata.hashes" type="pcre2"&gt;\b(MD5|SHA1|SHA256)\b&lt;/field&gt; &lt;!-- Windows Event Logs --&gt;
    &lt;list field="win.eventdata.hashes" lookup="match_key"&gt;etc/lists/misp_iocs.cdb&lt;/list&gt;
    &lt;description&gt;File hash from MISP detected in Windows event.&lt;/description&gt;
    &lt;group&gt;file_hash_misp,malware,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="100003" level="10"&gt;
    &lt;if_sid&gt;100001&lt;/if_sid&gt;
    &lt;field name="file.hash.md5" lookup="match_key"&gt;etc/lists/misp_iocs.cdb&lt;/list&gt;
    &lt;description&gt;MD5 hash from MISP detected (file integrity/audit).&lt;/description&gt;
    &lt;group&gt;file_hash_misp,malware,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="100004" level="10"&gt;
    &lt;if_sid&gt;100001&lt;/if_sid&gt;
    &lt;field name="file.hash.sha1" lookup="match_key"&gt;etc/lists/misp_iocs.cdb&lt;/list&gt;
    &lt;description&gt;SHA1 hash from MISP detected (file integrity/audit).&lt;/description&gt;
    &lt;group&gt;file_hash_misp,malware,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="100005" level="10"&gt;
    &lt;if_sid&gt;100001&lt;/if_sid&gt;
    &lt;field name="file.hash.sha256" lookup="match_key"&gt;etc/lists/misp_iocs.cdb&lt;/list&gt;
    &lt;description&gt;SHA256 hash from MISP detected (file integrity/audit).&lt;/description&gt;
    &lt;group&gt;file_hash_misp,malware,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;!-- Detección de IP maliciosa --&gt;
  &lt;rule id="100006" level="10"&gt;
    &lt;if_sid&gt;100001&lt;/if_sid&gt;
    &lt;field name="srcip" lookup="match_key"&gt;etc/lists/misp_iocs.cdb&lt;/list&gt;
    &lt;description&gt;Source IP from MISP detected.&lt;/description&gt;
    &lt;group&gt;ip_misp,malicious_ip,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="100007" level="10"&gt;
    &lt;if_sid&gt;100001&lt;/if_sid&gt;
    &lt;field name="dstip" lookup="match_key"&gt;etc/lists/misp_iocs.cdb&lt;/list&gt;
    &lt;description&gt;Destination IP from MISP detected.&lt;/description&gt;
    &lt;group&gt;ip_misp,malicious_ip,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;!-- Detección de Dominio/URL malicioso --&gt;
  &lt;rule id="100008" level="10"&gt;
    &lt;if_sid&gt;100001&lt;/if_sid&gt;
    &lt;field name="url" lookup="match_key"&gt;etc/lists/misp_iocs.cdb&lt;/list&gt;
    &lt;description&gt;URL from MISP detected.&lt;/description&gt;
    &lt;group&gt;domain_url_misp,phishing,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="100009" level="10"&gt;
    &lt;if_sid&gt;100001&lt;/if_sid&gt;
    &lt;field name="dsthostname" lookup="match_key"&gt;etc/lists/misp_iocs.cdb&lt;/list&gt;
    &lt;description&gt;Destination Hostname/Domain from MISP detected.&lt;/description&gt;
    &lt;group&gt;domain_url_misp,phishing,&lt;/group&gt;
  &lt;/rule&gt;

&lt;/group&gt;
</code></pre>
<p>Estas reglas utilizan el operador <code>lookup="match_key"</code> para verificar si el valor de un campo específico (como <code>srcip</code> o <code>file.hash.md5</code>) existe como clave en la lista <code>misp_iocs.cdb</code>.</p>

<h3>4. Automatizar la sincronización</h3>
<p>Programe el script Python para que se ejecute periódicamente (ej. cada hora) usando <code>cron</code>.</p>
<pre><code class="language-bash">crontab -e
</code></pre>
<p>Agregue la siguiente línea al final del archivo <code>crontab</code>. Asegúrese de que las variables de entorno para <code>MISP_URL</code> y <code>MISP_KEY</code> estén definidas en el entorno donde se ejecuta cron, o inclúyalas directamente en la línea de cron (menos recomendado por seguridad).</p>
<pre><code class="language-bash">0 * * * * MISP_URL="https://your-misp-instance.com" MISP_KEY="YOUR_MISP_API_KEY" /usr/bin/python3 /var/ossec/integrations/sync_misp_iocs.py &gt;/dev/null 2&gt;&amp;1
</code></pre>
<p>Este comando ejecutará el script cada hora, actualizando la lista CDB de Wazuh con los últimos IOCs de MISP.</p>

<h3>5. Reiniciar Wazuh</h3>
<p>Una vez que todas las configuraciones estén en su lugar, reinicie el manager de Wazuh para que los cambios surtan efecto.</p>
<pre><code class="language-bash">systemctl restart wazuh-manager
</code></pre>

<h2>Ejemplo práctico</h2>
<p>Vamos a simular la detección de un hash de archivo malicioso.</p>

<h3>1. Añadir IOC de prueba a MISP</h3>
<p>Acceda a su instancia de MISP y cree un nuevo evento o agregue un nuevo atributo a un evento existente con el siguiente hash MD5 (es un hash de ejemplo, no real): <code>d41d8cd98f00b204e9800998ecf8427e</code>.</p>

<h3>2. Sincronizar manualmente los IOCs</h3>
<p>Ejecute el script de sincronización manualmente para acelerar el proceso.</p>
<pre><code class="language-bash">MISP_URL="https://your-misp-instance.com" MISP_KEY="YOUR_MISP_API_KEY" /usr/bin/python3 /var/ossec/integrations/sync_misp_iocs.py
</code></pre>
<p>Verifique que el hash se haya añadido a <code>/var/ossec/etc/lists/misp_iocs.cdb</code>.</p>
<pre><code class="language-bash">grep "d41d8cd98f00b204e9800998ecf8427e" /var/ossec/etc/lists/misp_iocs.cdb
</code></pre>
<p>Debería ver una salida como: <code>d41d8cd98f00b204e9800998ecf8427e:1</code></p>

<h3>3. Simular un evento en un agente Wazuh</h3>
<p>En un agente Windows, intente simular un evento de registro con este hash (ej. un Sysmon FileCreate event):</p>
<p>Utilice el módulo <code>logcollector</code> de Wazuh para monitorear un archivo de log y añada una línea que contenga el hash. O, si tiene Sysmon configurado, puede simular la creación de un archivo con ese hash.</p>
<p>Ejemplo simple usando <code>logger</code> en un sistema Linux para simular una entrada de log que Wazuh podría parsear y detectar el hash:</p>
<pre><code class="language-bash">logger -t "test_misp_detection" "A file with MD5 hash d41d8cd98f00b204e9800998ecf8427e was accessed."
</code></pre>

<h3>4. Verificar la alerta de Wazuh</h3>
<p>Monitoree los logs de alertas en el Wazuh Manager:</p>
<pre><code class="language-bash">tail -f /var/ossec/logs/alerts/alerts.json | grep misp_ioc_detected
</code></pre>

<h3>Output esperado</h3>
<p>Debería ver una alerta JSON similar a esta (el contenido exacto puede variar):</p>
<pre><code class="language-json">{
  "timestamp": "2023-10-27T10:30:00.000Z",
  "rule": {
    "level": 10,
    "description": "MD5 hash from MISP detected (file integrity/audit).",
    "id": "100003",
    "firedtimes": 1,
    "mail": false,
    "groups": [
      "syslog",
      "misp_ioc_detected",
      "file_hash_misp",
      "malware"
    ]
  },
  "agent": {
    "id": "001",
    "name": "linux-agent"
  },
  "manager": {
    "name": "wazuh-manager"
  },
  "full_log": "A file with MD5 hash d41d8cd98f00b204e9800998ecf8427e was accessed.",
  "decoder": {
    "name": "json"
  },
  "location": "/var/log/syslog",
  "predecoder": {
    "program_name": "test_misp_detection"
  },
  "data": {
    "md5": "d41d8cd98f00b204e9800998ecf8427e"
  }
}
</code></pre>

<h3>Qué significa el resultado</h3>
<p>La alerta con <code>"id": "100003"</code> y la descripción "MD5 hash from MISP detected (file integrity/audit)." confirma que Wazuh ha detectado un evento que contiene un hash presente en la lista de IOCs de MISP. Esto valida la integración: la inteligencia de amenazas de MISP se está utilizando activamente para la detección en tiempo real en Wazuh.</p>

<h2>Conclusión</h2>
<p>La integración de Wazuh con MISP establece un mecanismo robusto para la ingestión y detección automatizada de inteligencia de amenazas. Al seguir estos pasos, las organizaciones pueden transformar un proceso manual y lento en una defensa proactiva y en tiempo real contra los indicadores de compromiso más recientes, reduciendo significativamente el tiempo de respuesta ante ataques emergentes. Esta automatización es fundamental para mantener una postura de seguridad sólida en un panorama de amenazas en constante evolución.</p>
<p>Implemente esta solución para fortalecer su seguridad y optimizar la gestión de amenazas. Para discutir cómo optimizar aún más su estrategia de seguridad con Wazuh y MISP, agende una reunión con nuestros expertos hoy mismo: /reunion.</p>

  <hr />

  <p class="text-sm text-base-600">
    <strong>¿Necesitas implementar esta solución?</strong> <a href="/reunion">Solicita una consulta gratuita aquí</a>.
  </p>
</BlogLayout>
