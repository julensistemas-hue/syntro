---
import BlogLayout from "../../layouts/BlogLayout.astro";
---

<BlogLayout
  title="Integración de Wazuh con MISP para Threat Intelligence"
  description="Integración de Wazuh con MISP para Threat Intelligence: Guía práctica para implementación empresarial en Wazuh"
  publishDate="2025-12-03"
  author="AI Security"
  readTime="8 min"
  tags={["MISP", "threat intelligence", "IOC", "indicators of compromise", "Wazuh", "Ciberseguridad"]}
  canonical="https://aisecurity.es/blog/integracion-de-wazuh-con-misp-para-threat-intelligence">

<p>Los equipos de seguridad se enfrentan al reto de gestionar manualmente la inteligencia de amenazas, lo que lleva a una postura de seguridad reactiva. Integrar Wazuh con MISP automatiza la ingestión de Indicadores de Compromiso (IOCs), permitiendo la detección proactiva directamente dentro de su infraestructura de monitoreo de seguridad.</p>

<h2>Caso de uso empresarial</h2>
<p>Una empresa que monitorea miles de endpoints necesita protección continua contra campañas de phishing, malware y ataques dirigidos. La aplicación manual de IOCs (IPs maliciosas, dominios de C2, hashes de malware) en su SIEM o HIDS es un proceso lento, propenso a errores y, sobre todo, reactivo. Mediante la integración de Wazuh con MISP, la empresa puede sincronizar automáticamente los nuevos IOCs, asegurando que cualquier intento de conexión a una IP o dominio malicioso conocido, o la ejecución de un archivo con un hash de malware, genere una alerta inmediata para el equipo SOC. Esto transforma la seguridad de reactiva a proactiva, mejorando significativamente el tiempo de respuesta.</p>

<h2>Requisitos previos</h2>
<ul>
    <li>Wazuh Manager 4.x (o superior) instalado y funcionando.</li>
    <li>Una instancia de MISP 2.4.x (o superior) con la API habilitada y una clave de autenticación generada.</li>
    <li>Python 3.x instalado en el Wazuh Manager.</li>
    <li>Acceso SSH al Wazuh Manager con permisos para modificar archivos de configuración y ejecutar scripts.</li>
</ul>

<h2>Instalación/Configuración</h2>

<h3>1. Instalar la librería <code>pymisp</code></h3>
<p>Acceda al Wazuh Manager y ejecute el siguiente comando para instalar la librería Python necesaria para interactuar con la API de MISP:</p>
<pre><code class="language-bash">pip3 install pymisp
</code></pre>

<h3>2. Crear el directorio y script de sincronización</h3>
<p>Cree un directorio para almacenar el script que extraerá los IOCs de MISP y los formateará para Wazuh.</p>
<pre><code class="language-bash">mkdir -p /var/ossec/integrations/misp
</code></pre>
<p>Ahora, cree el script <code>misp_wazuh_sync.py</code> dentro de este directorio. Este script se conectará a MISP, extraerá los IOCs (IPs y dominios en este ejemplo) y los guardará en un archivo de lista que Wazuh puede consumir.</p>
<pre><code class="language-bash">cat &lt;&lt; EOF &gt; /var/ossec/integrations/misp/misp_wazuh_sync.py
#!/usr/bin/env python3

from pymisp import PyMISP
from datetime import datetime, timedelta
import os
import sys
from urllib.parse import urlparse

# Configuración de MISP
MISP_URL = "https://your-misp-instance.com"  # Reemplaza con la URL de tu MISP
MISP_KEY = "YOUR_MISP_API_KEY"  # Reemplaza con tu clave API de MISP
MISP_VERIFY_SSL = True # Cambiar a False si usas certificados autofirmados y no quieres verificarlos

# Rutas de salida para los IOCs
IOC_LIST_DIR = "/var/ossec/etc/lists"
IP_IOC_FILE = os.path.join(IOC_LIST_DIR, "misp_ip_iocs.list")
DOMAIN_IOC_FILE = os.path.join(IOC_LIST_DIR, "misp_domain_iocs.list")

def get_misp_iocs():
    try:
        misp = PyMISP(MISP_URL, MISP_KEY, MISP_VERIFY_SSL, 'json')
    except Exception as e:
        print(f"Error al inicializar PyMISP: {"{"{"}"}{"}"}e{"}"}", file=sys.stderr)
        sys.exit(1)

    # Buscar eventos de los últimos 7 días. Ajusta esto según tu volumen de MISP y necesidades.
    events = misp.search(last="7d", output_type="json") 

    ip_iocs = set()
    domain_iocs = set()

    if events and isinstance(events, dict) and 'response' in events:
        for event_data in events['response']:
            if 'Attribute' in event_data:
                for attribute in event_data['Attribute']:
                    type = attribute.get('type')
                    value = attribute.get('value')

                    if not value:
                        continue

                    # Tipos de IOC para IPs
                    if type in ["ip-src", "ip-dst", "ip-src|port", "ip-dst|port"]:
                        # Extraer solo la IP si viene con puerto
                        if '|' in value:
                            value = value.split('|')[0]
                        ip_iocs.add(value)
                    
                    # Tipos de IOC para dominios
                    elif type in ["domain", "hostname", "url"]:
                        # Si es URL, extraer solo el dominio
                        if type == "url":
                            try:
                                parsed_url = urlparse(value)
                                if parsed_url.hostname:
                                    domain_iocs.add(parsed_url.hostname)
                                else: # Si no tiene hostname (ej. solo ruta o IP), ignorar como dominio
                                    continue
                            except Exception:
                                continue # Ignorar URLs mal formadas
                        else:
                            domain_iocs.add(value)

    return list(ip_iocs), list(domain_iocs)

def write_iocs_to_file(iocs, filepath):
    os.makedirs(os.path.dirname(filepath), exist_ok=True)
    try:
        with open(filepath, 'w') as f:
            for ioc in iocs:
                f.write(f"{"{"{"}"}{"}"}ioc{"}"}\n")
        print(f"[{"{"{"}"}{"}"}datetime.now(){"}"}] {"{"{"}"}{"}"}len(iocs){"}"} IOCs escritos en {"{"{"}"}{"}"}filepath{"}"}")
    except Exception as e:
        print(f"Error al escribir en {"{"{"}"}{"}"}filepath{"}"}: {"{"{"}"}{"}"}e{"}"}", file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    print(f"[{"{"{"}"}{"}"}datetime.now(){"}"}] Iniciando sincronización de IOCs de MISP...")
    ips, domains = get_misp_iocs()
    write_iocs_to_file(ips, IP_IOC_FILE)
    write_iocs_to_file(domains, DOMAIN_IOC_FILE)
    print(f"[{"{"{"}"}{"}"}datetime.now(){"}"}] Sincronización de IOCs de MISP finalizada.")
EOF
</code></pre>
<p>Asigne permisos de ejecución al script:</p>
<pre><code class="language-bash">chmod +x /var/ossec/integrations/misp/misp_wazuh_sync.py
</code></pre>
<p><strong>IMPORTANTE:</strong> Reemplace <code>https://your-misp-instance.com</code> y <code>YOUR_MISP_API_KEY</code> con los valores reales de su instancia MISP.</p>

<h3>3. Configurar listas de Wazuh y reglas personalizadas</h3>
<p>Modifique el archivo <code>/var/ossec/etc/ossec.conf</code> en el Wazuh Manager para incluir las listas de IOCs generadas por el script. Agregue las siguientes líneas dentro de la sección <code>&lt;ossec_config&gt;</code> (preferiblemente cerca de otras secciones <code>&lt;ruleset&gt;</code>).</p>
<pre><code class="language-bash">sed -i '/<\/ruleset>/i \    <list>etc/lists/misp_ip_iocs.list</list>\n    <list>etc/lists/misp_domain_iocs.list</list>' /var/ossec/etc/ossec.conf
</code></pre>
<p>Cree un archivo de reglas personalizado <code>/var/ossec/etc/rules/local_rules.xml</code> (o edítelo si ya existe) para definir reglas que alerten cuando se detecten IOCs.</p>
<pre><code class="language-bash">cat &lt;&lt; EOF &gt; /var/ossec/etc/rules/local_rules.xml
&lt;group name="syslog,misp,"&gt;

  &lt;rule id="100001" level="10"&gt;
    &lt;if_sid&gt;5503&lt;/if_sid&gt; &lt;!-- Rule 5503: Generic log message (modify to fit your specific log source for IPs/domains) --&gt;
    &lt;list field="srcip" lookup="match_key_value"&gt;etc/lists/misp_ip_iocs.list&lt;/list&gt;
    &lt;description&gt;MISP: Source IP $(srcip) detected as a known malicious IP.&lt;/description&gt;
    &lt;group&gt;attack,pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,nist_800_53_SI.4,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="100002" level="10"&gt;
    &lt;if_sid&gt;5503&lt;/if_sid&gt; &lt;!-- Rule 5503: Generic log message (modify to fit your specific log source for IPs/domains) --&gt;
    &lt;list field="dstip" lookup="match_key_value"&gt;etc/lists/misp_ip_iocs.list&lt;/list&gt;
    &lt;description&gt;MISP: Destination IP $(dstip) detected as a known malicious IP.&lt;/description&gt;
    &lt;group&gt;attack,pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,nist_800_53_SI.4,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="100003" level="10"&gt;
    &lt;if_sid&gt;5503&lt;/if_sid&gt; &lt;!-- Rule 5503: Generic log message (modify to fit your specific log source for IPs/domains) --&gt;
    &lt;list field="url" lookup="match_key_value"&gt;etc/lists/misp_domain_iocs.list&lt;/list&gt;
    &lt;description&gt;MISP: URL $(url) contains a known malicious domain.&lt;/description&gt;
    &lt;group&gt;attack,pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,nist_800_53_SI.4,&lt;/group&gt;
  &lt;/rule&gt;

  &lt;rule id="100004" level="10"&gt;
    &lt;if_sid&gt;5503&lt;/if_sid&gt; &lt;!-- Rule 5503: Generic log message (modify to fit your specific log source for IPs/domains) --&gt;
    &lt;list field="domain" lookup="match_key_value"&gt;etc/lists/misp_domain_iocs.list&lt;/list&gt;
    &lt;description&gt;MISP: Domain $(domain) detected as a known malicious domain.&lt;/description&gt;
    &lt;group&gt;attack,pci_dss_10.6.1,gdpr_IV_35.7.d,nist_800_53_AU.6,nist_800_53_SI.4,&lt;/group&gt;
  &lt;/rule&gt;

&lt;/group&gt;
EOF
</code></pre>
<p><strong>Nota sobre las reglas:</strong> Las reglas 100001-100004 utilizan <code>if_sid&gt;5503</code> y campos genéricos (<code>srcip</code>, <code>dstip</code>, <code>url</code>, <code>domain</code>). En un entorno real, debe ajustar estas reglas para que coincidan con los <code>sid</code> específicos y los campos de sus decodificadores que contengan IPs o dominios de los logs que está monitoreando (ej. logs de firewall, proxy, DNS).</p>
<p>Reinicie el Wazuh Manager para aplicar los cambios en la configuración y las reglas:</p>
<pre><code class="language-bash">systemctl restart wazuh-manager
</code></pre>

<h3>4. Programar la sincronización con Cron</h3>
<p>Para automatizar la extracción de IOCs de MISP, programe el script para que se ejecute periódicamente usando <code>cron</code>. Esto actualizará las listas de Wazuh automáticamente.</p>
<p>Edite el crontab del usuario root:</p>
<pre><code class="language-bash">crontab -e
</code></pre>
<p>Agregue la siguiente línea al final del archivo para ejecutar el script cada hora (ajuste la frecuencia según sus necesidades):</p>
<pre><code class="language-cron">0 * * * * /var/ossec/integrations/misp/misp_wazuh_sync.py &gt;&gt; /var/log/wazuh/misp_sync.log 2&gt;&amp;1
</code></pre>
<p>Guarde y cierre el archivo. El script ahora se ejecutará automáticamente y actualizará las listas de IOCs.</p>

<h2>Ejemplo práctico</h2>
<p>Para demostrar la integración, asumamos que su instancia de MISP contiene un evento con la IP maliciosa <code>192.0.2.1</code>. Después de que el script <code>misp_wazuh_sync.py</code> se haya ejecutado (manualmente o por cron), esta IP estará en el archivo <code>/var/ossec/etc/lists/misp_ip_iocs.list</code>.</p>

<h3>1. Verificar la presencia del IOC</h3>
<p>Compruebe que la IP esté en la lista generada:</p>
<pre><code class="language-bash">grep "192.0.2.1" /var/ossec/etc/lists/misp_ip_iocs.list
</code></pre>
<p><strong>Output esperado (si la IP existe en MISP y se ha sincronizado):</strong></p>
<pre><code class="language-text">192.0.2.1
</code></pre>

<h3>2. Simular un log en un agente Wazuh</h3>
<p>Desde un agente Wazuh (que está siendo monitoreado por el Manager), simule un intento de conexión a esa IP maliciosa. Por ejemplo, un log genérico de firewall:</p>
<pre><code class="language-bash">logger -t firewall "DROP IN=eth0 OUT=eth1 SRC=10.0.0.5 DST=192.0.2.1 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=49216 DF PROTO=TCP SPT=55694 DPT=80 WINDOW=29200 RES=0x00 SYN URGP=0"
</code></pre>

<h3>3. Observar la alerta en Wazuh</h3>
<p>Monitoree los logs de alertas en el Wazuh Manager (o en la UI de Wazuh/Kibana). Debería ver una alerta similar a esta (el output exacto puede variar):</p>
<pre><code class="language-json">
{"{"{"}"}{"}"}
  "timestamp": "2023-10-27T10:30:00.000Z",
  "rule": {"{"{"}"}{"}"}
    "level": 10,
    "description": "MISP: Destination IP 192.0.2.1 detected as a known malicious IP.",
    "id": "100002",
    "firedtimes": 1,
    "mail": false,
    "gdpr": ["IV_35.7.d"],
    "nist_800_53": ["AU.6", "SI.4"],
    "pci_dss": ["10.6.1"],
    "groups": ["syslog", "misp", "attack"]
  {"}"},
  "agent": {"{"{"}"}{"}"}
    "id": "001",
    "name": "your-agent-name"
  {"}"},
  "manager": {"{"{"}"}{"}"}
    "name": "your-wazuh-manager"
  {"}"},
  "id": "1698402600.12345",
  "full_log": "DROP IN=eth0 OUT=eth1 SRC=10.0.0.5 DST=192.0.2.1 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=49216 DF PROTO=TCP SPT=55694 DPT=80 WINDOW=29200 RES=0x00 SYN URGP=0",
  "decoder": {"{"{"}"}{"}"}
    "name": "syslog"
  {"}"},
  "data": {"{"{"}"}{"}"}
    "srcip": "10.0.0.5",
    "dstip": "192.0.2.1",
    "protocol": "TCP",
    "srcport": "55694",
    "dstport": "80",
    "action": "DROP"
  {"}"},
  "location": "/var/log/syslog"
{"}"}
</code></pre>
<p>El <code>full_log</code> será el mensaje que el agente envió, y los campos decodificados (<code>srcip</code>, <code>dstip</code>) serán utilizados por las reglas de Wazuh para hacer la coincidencia con las listas de IOCs. La presencia de la regla <code>id: 100002</code> y su descripción confirma que Wazuh ha detectado un IOC proveniente de MISP.</p>

<h2>Conclusión</h2>
<p>La integración de Wazuh con MISP establece un flujo automatizado y proactivo para la gestión de inteligencia de amenazas. Al sincronizar automáticamente los IOCs de MISP, Wazuh puede identificar y alertar sobre actividades maliciosas conocidas en tiempo real, fortaleciendo la postura de seguridad y reduciendo el tiempo de detección y respuesta a incidentes.</p>
<p>Esta configuración minimiza el esfuerzo manual y asegura que su defensa esté siempre actualizada con la última información de amenazas. ¿Necesita implementar esta solución o explorar cómo Wazuh puede mejorar su ciberseguridad? Contáctenos para una <a href="/reunion">reunión</a>.</p>

  <hr />

  <p class="text-sm text-base-600">
    <strong>¿Necesitas implementar esta solución?</strong> <a href="/reunion">Solicita una consulta gratuita aquí</a>.
  </p>
</BlogLayout>
