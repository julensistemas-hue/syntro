---
import BlogLayout from "../../layouts/BlogLayout.astro";
---

<BlogLayout
  title="Integración de Wazuh con MISP para Threat Intelligence"
  description="Integración de Wazuh con MISP para Threat Intelligence: Guía práctica para implementación empresarial en Wazuh"
  publishDate="2025-12-03"
  author="AI Security"
  readTime="8 min"
  tags={["MISP", "threat intelligence", "IOC", "indicators of compromise", "Wazuh", "Ciberseguridad"]}
  canonical="https://aisecurity.es/blog/integracion-de-wazuh-con-misp-para-threat-intelligence">

<p>Los equipos de seguridad a menudo carecen de contexto para priorizar las miles de alertas que genera un SIEM. La integración de Wazuh con una plataforma de <strong>Threat Intelligence</strong> como MISP automatiza la ingesta de Indicadores de Compromiso (<strong>IOC</strong>), permitiendo detectar amenazas conocidas en tiempo real y enriquecer las alertas con inteligencia accionable.</p>

<h2>Caso de Uso Empresarial</h2>
<p>Una institución financiera utiliza Wazuh para monitorizar su infraestructura. Reciben informes de inteligencia sobre nuevas campañas de malware dirigidas a su sector, incluyendo direcciones IP maliciosas y hashes de archivos. Sin automatización, sus analistas deben cruzar manualmente las alertas de Wazuh con estos <strong>IOCs</strong>, un proceso lento y propenso a errores. El objetivo es alimentar automáticamente estos <strong>IOCs</strong> desde su instancia de MISP a Wazuh para generar alertas de alta prioridad instantáneamente cuando ocurra una coincidencia.</p>

<h2>Requisitos Previos</h2>
<ul>
    <li>Wazuh Manager (v4.3 o superior) con acceso <code>root</code> o <code>sudo</code>.</li>
    <li>Una instancia de MISP accesible desde el Wazuh Manager.</li>
    <li>Una API Key de MISP con permisos de autenticación (Auth Key).</li>
    <li>Python 3.6+ y pip instalados en el entorno de Wazuh.</li>
</ul>

<h2>Instalación y Configuración</h2>

<h3>1. Instalar la librería PyMISP</h3>
<p>Utilizamos el intérprete de Python que viene con Wazuh para mantener las dependencias aisladas y asegurar la compatibilidad.</p>
<pre><code class="language-bash">
/var/ossec/framework/python/bin/pip3 install pymisp
</code></pre>

<h3>2. Crear el script de sincronización de IOCs</h3>
<p>Este script Python se conecta a la API de MISP, descarga los <strong>Indicators of Compromise</strong> (IPs, dominios, hashes) y los formatea para una lista CDB de Wazuh. Crea el archivo en <code>/var/ossec/integrations/misp_sync.py</code>.</p>
<pre><code class="language-python">
#!/var/ossec/framework/python/bin/python3

import sys
from pymisp import PyMISP

# --- Configuración de MISP ---
# Reemplaza con la URL de tu instancia de MISP y tu API Key
misp_url = 'https://TU_MISP_URL/'
misp_key = 'TU_MISP_API_KEY'
misp_verifycert = True  # Cambiar a False si usas un certificado autofirmado

# --- Configuración de Wazuh ---
output_file = '/var/ossec/etc/lists/misp-iocs'

# --- Tipos de IOC a extraer ---
# Puedes añadir o quitar tipos de atributos de MISP
ioc_types = ['ip-src', 'ip-dst', 'domain', 'md5', 'sha1', 'sha256']

def fetch_misp_iocs():
    """
    Se conecta a MISP y obtiene los IOCs.
    """
    try:
        misp = PyMISP(misp_url, misp_key, misp_verifycert)
        print("Conexión a MISP exitosa.")
        
        iocs = set()
        for ioc_type in ioc_types:
            print(f"Buscando IOCs del tipo: {ioc_type}...")
            # 'last' define el periodo de tiempo a consultar. Ej: '1d', '90d', '1y'
            result = misp.search(controller='attributes', type_attribute=ioc_type, last='90d')
            for attribute in result:
                ioc_value = attribute['Attribute']['value']
                # Formato para lista CDB de Wazuh: 'valor:tipo_de_ioc'
                iocs.add(f"{ioc_value}:{ioc_type}")

        return iocs

    except Exception as e:
        print(f"Error al conectar o buscar en MISP: {e}")
        sys.exit(1)

def write_cdb_list(iocs):
    """
    Escribe los IOCs en el archivo de lista CDB.
    """
    try:
        with open(output_file, 'w') as f:
            for ioc in sorted(iocs):
                f.write(f"{ioc}\n")
        print(f"Se escribieron {len(iocs)} IOCs en {output_file}")
    except Exception as e:
        print(f"Error al escribir el archivo CDB: {e}")
        sys.exit(1)

if __name__ == "__main__":
    iocs_from_misp = fetch_misp_iocs()
    if iocs_from_misp:
        write_cdb_list(iocs_from_misp)
    else:
        print("No se encontraron nuevos IOCs.")
</code></pre>
<p>Asegúrate de dar permisos de ejecución al script:</p>
<pre><code class="language-bash">
chmod +x /var/ossec/integrations/misp_sync.py
chown wazuh:wazuh /var/ossec/integrations/misp_sync.py
</code></pre>

<h3>3. Configurar Wazuh para usar la lista CDB</h3>
<p>Edita el archivo de configuración del Wazuh Manager <code>/var/ossec/etc/ossec.conf</code> y añade la siguiente línea dentro de la sección <code>&lt;ruleset&gt;</code> para que Wazuh cargue tu nueva lista de <strong>IOCs</strong>.</p>
<pre><code class="language-xml">
&lt;ruleset&gt;
  ...
  &lt;list&gt;etc/lists/misp-iocs&lt;/list&gt;
  ...
&lt;/ruleset&gt;
</code></pre>
<p>Reinicia el manager para aplicar los cambios:</p>
<pre><code class="language-bash">
systemctl restart wazuh-manager
</code></pre>

<h3>4. Crear una regla personalizada de detección</h3>
<p>Añade la siguiente regla al archivo <code>/var/ossec/etc/rules/local_rules.xml</code>. Esta regla se disparará cuando un campo del evento (como una IP de origen o un hash de fichero) coincida con una entrada en nuestra lista <code>misp-iocs</code>.</p>
<pre><code class="language-xml">
&lt;group name="misp,threat_intelligence,"&gt;
  &lt;rule id="100100" level="12"&gt;
    &lt;list field="srcip" lookup="address_match_key"&gt;etc/lists/misp-iocs&lt;/list&gt;
    &lt;list field="dstip" lookup="address_match_key"&gt;etc/lists/misp-iocs&lt;/list&gt;
    &lt;list field="file.md5" lookup="match_key"&gt;etc/lists/misp-iocs&lt;/list&gt;
    &lt;list field="file.sha1" lookup="match_key"&gt;etc/lists/misp-iocs&lt;/list&gt;
    &lt;list field="file.sha256" lookup="match_key"&gt;etc/lists/misp-iocs&lt;/list&gt;
    &lt;list field="win.eventdata.destinationIp" lookup="address_match_key"&gt;etc/lists/misp-iocs&lt;/list&gt;
    &lt;description&gt;MISP Threat Intelligence: Indicador de Compromiso (IOC) detectado.&lt;/description&gt;
    &lt;options&gt;no_full_log&lt;/options&gt;
  &lt;/rule&gt;
&lt;/group&gt;
</code></pre>
<p>Reinicia el manager de nuevo para cargar la nueva regla.</p>
<pre><code class="language-bash">
systemctl restart wazuh-manager
</code></pre>

<h3>5. Automatizar la sincronización con Cron</h3>
<p>Para mantener la lista de <strong>IOCs</strong> actualizada, configura un cronjob para ejecutar el script periódicamente (por ejemplo, cada hora).</p>
<pre><code class="language-bash">
crontab -e
# Añade la siguiente línea al final del archivo:
0 * * * * /var/ossec/framework/python/bin/python3 /var/ossec/integrations/misp_sync.py > /dev/null 2>&1
</code></pre>

<h2>Ejemplo Práctico</h2>
<p>Primero, ejecuta el script manualmente para poblar la lista de <strong>IOCs</strong> por primera vez.</p>
<pre><code class="language-bash">
/var/ossec/integrations/misp_sync.py
</code></pre>
<p>Supongamos que tu instancia de MISP contiene el <strong>IOC</strong> de tipo <code>ip-src</code> con el valor <code>198.51.100.50</code>. El script lo añadirá al archivo <code>/var/ossec/etc/lists/misp-iocs</code> como <code>198.51.100.50:ip-src</code>.</p>

<p>Ahora, simula un evento de seguridad que involucre esa IP maliciosa. Podemos generar un log de sistema falso en un agente monitorizado por Wazuh.</p>

<h3>Comando de Prueba</h3>
<pre><code class="language-bash">
# Ejecuta este comando en un agente Linux monitorizado
logger "sshd: Failed password for invalid user admin from 198.51.100.50 port 22"
</code></pre>

<h3>Output Esperado</h3>
<p>Revisa las alertas en el dashboard de Wazuh o directamente en <code>/var/ossec/logs/alerts/alerts.json</code> en el manager. Verás una alerta similar a esta:</p>
<pre><code class="language-json">
{
  "timestamp": "2023-10-27T10:30:00.123+0000",
  "rule": {
    "level": 12,
    "description": "MISP Threat Intelligence: Indicador de Compromiso (IOC) detectado.",
    "id": "100100",
    "groups": ["misp", "threat_intelligence"]
  },
  "agent": {
    "id": "001",
    "name": "agent-linux"
  },
  "manager": {
    "name": "wazuh-server"
  },
  "data": {
    "srcip": "198.51.100.50"
  },
  "location": "/var/log/syslog",
  "full_log": "sshd: Failed password for invalid user admin from 198.51.100.50 port 22"
}
</code></pre>

<h3>Qué significa el resultado</h3>
<p>Wazuh ha procesado el log del agente, ha extraído la IP de origen <code>198.51.100.50</code> y la ha comparado con la lista <code>misp-iocs</code>. Al encontrar una coincidencia, disparó la regla personalizada <strong>100100</strong>, generando una alerta de alta severidad (nivel 12). Tu equipo de seguridad ahora sabe que una comunicación con un indicador de compromiso conocido ha ocurrido en la red.</p>

<h2>Conclusión</h2>
<p>Has implementado un pipeline automatizado para enriquecer Wazuh con <strong>Threat Intelligence</strong> de alta fidelidad desde MISP. Esto transforma tu SIEM de una herramienta reactiva a un sistema de detección proactiva, capaz de identificar amenazas conocidas basándose en <strong>Indicators of Compromise</strong> compartidos por la comunidad de seguridad.</p>

<p>Este enfoque reduce el ruido, prioriza alertas críticas y permite a tu equipo responder más rápido a incidentes reales. Si necesitas ayuda para implementar esta u otras soluciones de ciberseguridad avanzada, agenda una reunión con nuestro equipo de expertos en /reunion.</p>

  <hr />

  <p class="text-sm text-base-600">
    <strong>¿Necesitas implementar esta solución?</strong> <a href="/reunion">Solicita una consulta gratuita aquí</a>.
  </p>
</BlogLayout>
