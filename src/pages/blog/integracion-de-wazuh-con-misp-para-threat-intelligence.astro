---
import BlogLayout from "../../layouts/BlogLayout.astro";
---

<BlogLayout
  title="Integración de Wazuh con MISP para Threat Intelligence"
  description="Integración de Wazuh con MISP para Threat Intelligence: Guía práctica para implementación empresarial en Wazuh"
  publishDate="2025-12-03"
  author="AI Security"
  readTime="8 min"
  tags={["MISP", "threat intelligence", "IOC", "indicators of compromise", "Wazuh", "Ciberseguridad"]}
  canonical="https://aisecurity.es/blog/integracion-de-wazuh-con-misp-para-threat-intelligence">

<p>La inteligencia de amenazas es crucial. Integrar <strong>Wazuh</strong> con <strong>MISP (Malware Information Sharing Platform)</strong> automatiza la ingestión de Indicadores de Compromiso (IOCs), transformando su defensa de reactiva a proactiva. Detecte amenazas antes de que escalen.</p>

<h2>Caso de uso empresarial</h2>
<p>Una empresa tecnológica es un blanco frecuente de ataques dirigidos. Utiliza MISP para recibir y compartir IOCs de campañas de phishing, malware y vulnerabilidades activas relevantes para su sector. El desafío es cómo integrar estos IOCs dinámicamente en su sistema SIEM/EDR para una detección temprana. La integración con Wazuh permite que cualquier nuevo IOC en MISP sea automáticamente cargado en Wazuh, alertando al SOC cuando una IP maliciosa, dominio o hash de archivo se detecta en la infraestructura.</p>

<h2>Requisitos previos</h2>
<ul>
    <li>Un servidor <strong>Wazuh Manager</strong> (versión 4.x o superior) con acceso a Internet.</li>
    <li>Una instancia de <strong>MISP</strong> operativa y accesible desde el Wazuh Manager.</li>
    <li>Una <strong>API key de MISP</strong> con permisos de lectura.</li>
    <li>Acceso SSH con privilegios de root/sudo al Wazuh Manager.</li>
</ul>

<h2>Instalación/Configuración</h2>

<h3>Paso 1: Instalar dependencias en el Wazuh Manager</h3>
<p>Instale Python 3 y la librería <code>pymisp</code> necesaria para interactuar con la API de MISP.</p>
<pre><code class="language-bash">sudo apt update
sudo apt install python3 python3-pip -y
pip3 install pymisp
</code></pre>

<h3>Paso 2: Crear el script de sincronización de IOCs de MISP</h3>
<p>Cree un script Python en el Wazuh Manager que descargue los IOCs de MISP y los formatee en una lista de Wazuh (CDB list). Este script actualizará un archivo <code>custom-misp-iocs.cdb</code>.</p>
<pre><code class="language-bash">sudo mkdir -p /var/ossec/etc/lists
sudo nano /var/ossec/etc/misp_sync.py
</code></pre>
<p>Copie el siguiente contenido en el archivo <code>/var/ossec/etc/misp_sync.py</code>:</p>
<pre><code class="language-python">import os
from pymisp import PyMISP
from datetime import datetime, timedelta

# --- Configuración de MISP ---
# Se recomienda usar variables de entorno para las credenciales en producción
misp_url = os.environ.get("MISP_URL", "https://your-misp-instance.com") # Reemplace con la URL de su MISP
misp_key = os.environ.get("MISP_API_KEY", "YOUR_MISP_API_KEY") # Reemplace con su API Key de MISP
misp_verifycert = os.environ.get("MISP_VERIFY_CERT", "True").lower() == "true" # False si usa certificados autofirmados/dev

# --- Rutas de Wazuh ---
wazuh_list_path = "/var/ossec/etc/lists/custom-misp-iocs.cdb"

# --- Inicializar PyMISP ---
try:
    misp = PyMISP(misp_url, misp_key, misp_verifycert)
except Exception as e:
    print(f"Error al inicializar PyMISP: {e}")
    exit(1)

def get_misp_iocs():
    iocs = set()
    # Fecha de hace 1 día para buscar eventos recientes
    from_date = (datetime.now() - timedelta(days=1)).strftime("%Y-%m-%d")

    # Tipos de atributos a buscar (IPs, dominios, hashes de archivos)
    attribute_types = [
        "ip-src", "ip-dst", "domain", "hostname",
        "md5", "sha1", "sha256", "filename|md5", "filename|sha1", "filename|sha256"
    ]

    print(f"Fetching IOCs from MISP since {from_date}...")
    for attr_type in attribute_types:
        try:
            # Buscar atributos actualizados en las últimas 24h
            results = misp.search(controller='attributes', type_attribute=attr_type, last=from_date)
            if 'Attribute' in results:
                for attr in results['Attribute']:
                    value = attr.get('value')
                    if value and attr_type.startswith("filename|"): # Para hashes en filenames
                        value = value.split("|")[-1] # Obtener solo el hash
                    if value:
                        iocs.add(value)
            print(f"  - Fetched {len(iocs)} total unique IOCs so far.")
        except Exception as e:
            print(f"Error fetching attribute type {attr_type}: {e}")
            continue
    return iocs

def update_wazuh_list(iocs):
    try:
        with open(wazuh_list_path, 'w') as f:
            for ioc in sorted(list(iocs)):
                f.write(f"{ioc}:malicious\n")
        print(f"Successfully updated {wazuh_list_path} with {len(iocs)} IOCs.")
    except Exception as e:
        print(f"Error writing to Wazuh list file: {e}")

if __name__ == "__main__":
    misp_iocs = get_misp_iocs()
    if misp_iocs:
        update_wazuh_list(misp_iocs)
    else:
        print("No new IOCs found in MISP or error occurred.")
</code></pre>

<p>Asegúrese de reemplazar <code>https://your-misp-instance.com</code> y <code>YOUR_MISP_API_KEY</code> con sus valores reales. Si usa un certificado autofirmado, cambie <code>misp_verifycert</code> a <code>False</code> o configure la variable de entorno <code>MISP_VERIFY_CERT=False</code>.</p>
<p>Haga el script ejecutable:</p>
<pre><code class="language-bash">sudo chmod +x /var/ossec/etc/misp_sync.py
</code></pre>

<h3>Paso 3: Configurar reglas de Wazuh para los IOCs</h3>
<p>Edite el archivo <code>/var/ossec/etc/rules/local_rules.xml</code> en el Wazuh Manager para crear reglas que usen la nueva lista de IOCs.</p>
<pre><code class="language-bash">sudo nano /var/ossec/etc/rules/local_rules.xml
</code></pre>
<p>Agregue las siguientes reglas dentro de la etiqueta <code>&lt;group&gt;</code> (o cree una nueva si no existe <code>local</code>). Estas reglas buscan la IP de origen o destino en el archivo <code>custom-misp-iocs.cdb</code>.</p>
<pre><code class="language-xml">&lt;!-- Reglas para la integración de MISP --&gt;
&lt;group name="misp_threat_intelligence,"&gt;

  &lt;!-- Detección de IP de origen maliciosa --&gt;
  &lt;rule id="100001" level="12"&gt;
    &lt;if_sid&gt;2500,5710,60103&lt;/if_sid&gt; &lt;!-- Ej. Firewall (2500), SSH (5710), Sysmon Network (60103) --&gt;
    &lt;list field="srcip" lookup="match_key"&gt;etc/lists/custom-misp-iocs.cdb&lt;/list&gt;
    &lt;description&gt;MISP TI: Source IP $(srcip) is a known malicious IOC.&lt;/description&gt;
    &lt;group&gt;attack,gpl_attack,pci_dss_11.4&lt;/group&gt;
  &lt;/rule&gt;

  &lt;!-- Detección de IP de destino maliciosa --&gt;
  &lt;rule id="100002" level="12"&gt;
    &lt;if_sid&gt;2500,60103&lt;/if_sid&gt; &lt;!-- Ej. Firewall (2500), Sysmon Network (60103) --&gt;
    &lt;list field="dstip" lookup="match_key"&gt;etc/lists/custom-misp-iocs.cdb&lt;/list&gt;
    &lt;description&gt;MISP TI: Destination IP $(dstip) is a known malicious IOC.&lt;/description&gt;
    &lt;group&gt;attack,gpl_attack,pci_dss_11.4&lt;/group&gt;
  &lt;/rule&gt;

  &lt;!-- NOTA: Para dominios o hashes, se requieren decodificadores específicos que extraigan esos campos.
       Ejemplo para un dominio si 'dstdomain' se extrae de logs DNS o proxy:
  &lt;rule id="100003" level="12"&gt;
    &lt;if_sid&gt;110000&lt;/if_sid&gt; &lt;!-- Regla base de ejemplo para consultas DNS (ID ficticio) --&gt;
    &lt;list field="query" lookup="match_key"&gt;etc/lists/custom-misp-iocs.cdb&lt;/list&gt;
    &lt;description&gt;MISP TI: DNS Query for known malicious domain $(query).&lt;/description&gt;
    &lt;group&gt;attack,gpl_attack,pci_dss_11.4&lt;/group&gt;
  &lt;/rule&gt;
  --&gt;

&lt;/group&gt;
</code></pre>
<p>Reinicie el Wazuh Manager para aplicar los cambios en las reglas:</p>
<pre><code class="language-bash">sudo systemctl restart wazuh-manager
</code></pre>

<h3>Paso 4: Automatizar la sincronización con Cron</h3>
<p>Configure una tarea cron para ejecutar el script de sincronización regularmente (ej., cada 15 minutos).</p>
<pre><code class="language-bash">sudo crontab -e
</code></pre>
<p>Agregue la siguiente línea al final del archivo:</p>
<pre><code class="language-bash">*/15 * * * * /usr/bin/python3 /var/ossec/etc/misp_sync.py > /dev/null 2>&1
</code></pre>
<p>Guarde y cierre el archivo. Ahora, los IOCs de MISP se actualizarán automáticamente en Wazuh.</p>

<h2>Ejemplo práctico</h2>
<p>Para demostrar la integración, añadiremos una IP maliciosa a MISP y luego simularemos tráfico desde esa IP.</p>

<h3>Paso 1: Añadir un IOC en MISP</h3>
<p>Acceda a su instancia de MISP. Cree un nuevo evento o añada un nuevo atributo a un evento existente. Por ejemplo, añada una IP de origen de tipo <code>ip-src</code> con el valor <code>192.0.2.1</code> (una IP reservada para ejemplos, asegúrese de que no esté en uso real en su red).</p>

<h3>Paso 2: Ejecutar la sincronización y verificar la lista</h3>
<p>Ejecute manualmente el script de sincronización para que el IOC se importe de inmediato:</p>
<pre><code class="language-bash">sudo /var/ossec/etc/misp_sync.py
</code></pre>
<p>Verifique que la IP <code>192.0.2.1</code> esté ahora en la lista de IOCs de Wazuh:</p>
<pre><code class="language-bash">cat /var/ossec/etc/lists/custom-misp-iocs.cdb | grep "192.0.2.1"
</code></pre>
<p><strong>Output esperado:</strong></p>
<pre><code class="language-bash">192.0.2.1:malicious
</code></pre>
<p>Esto confirma que Wazuh ha cargado la IP en su lista.</p>

<h3>Paso 3: Simular una alerta</h3>
<p>Simule un intento de conexión SSH desde esta IP maliciosa. Ejecute el siguiente comando en un agente Wazuh (o en el propio Manager si también es un agente y monitorea <code>/var/log/auth.log</code>):</p>
<pre><code class="language-bash">logger -p auth.info -t sshd "Failed password for invalid user misptest from 192.0.2.1 port 54321 ssh2"
</code></pre>

<h3>Paso 4: Verificar la alerta en Wazuh</h3>
<p>Monitorice el archivo de alertas de Wazuh o acceda a la interfaz de Wazuh para ver las alertas recientes.</p>
<pre><code class="language-bash">tail -f /var/ossec/logs/alerts/alerts.json | grep "100001"
</code></pre>
<p><strong>Output esperado (fragmento):</strong></p>
<pre><code class="language-json">{
  "rule": {
    "level": 12,
    "description": "MISP TI: Source IP 192.0.2.1 is a known malicious IOC.",
    "id": "100001",
    "firedtimes": 1,
    "mail": false,
    "groups": [
      "misp_threat_intelligence",
      "attack",
      "gpl_attack",
      "pci_dss_11.4"
    ]
  },
  "agent": {
    "id": "000",
    "name": "wazuh-manager"
  },
  "manager": {
    "name": "wazuh-manager"
  },
  "id": "...",
  "full_log": "Aug 20 10:30:00 wazuh-manager sshd[12345]: Failed password for invalid user misptest from 192.0.2.1 port 54321 ssh2",
  "predecoder": {
    "program_name": "sshd",
    "timestamp": "Aug 20 10:30:00"
  },
  "decoder": {
    "parent": "sshd",
    "program_name": "sshd",
    "dstuser": "misptest",
    "srcip": "192.0.2.1",
    "dstport": "54321",
    "protocol": "ssh2"
  },
  "data": {
    "srcip": "192.0.2.1"
  },
  "location": "/var/log/auth.log"
}
</code></pre>
<p><strong>Qué significa el resultado:</strong>
La alerta JSON muestra que la regla con <code>id: "100001"</code> se ha activado, indicando que la IP de origen <code>192.0.2.1</code> (extraída del log simulado) fue detectada como un IOC malicioso proveniente de MISP. Esto valida la correcta integración y funcionalidad de la inteligencia de amenazas.</p>

<h2>Conclusión</h2>
<p>La integración de Wazuh con MISP establece un sistema robusto de detección de amenazas basado en inteligencia de amenazas actualizada. Al automatizar la ingesta de IOCs, las organizaciones fortalecen su postura de seguridad, moviéndose de un modelo reactivo a uno proactivo, identificando y mitigando riesgos de manera más eficiente y en tiempo real.</p>
<p>¿Interesado en implementar esta solución o explorar otras capacidades de ciberseguridad? Agenda una reunión con nuestros expertos para discutir cómo podemos optimizar su defensa.</p>

  <hr />

  <p class="text-sm text-base-600">
    <strong>¿Necesitas implementar esta solución?</strong> <a href="/reunion">Solicita una consulta gratuita aquí</a>.
  </p>
</BlogLayout>
