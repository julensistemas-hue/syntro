---
import BlogLayout from "../../layouts/BlogLayout.astro";
---

<BlogLayout
  title="Integración de Wazuh con MISP para Threat Intelligence"
  description="Integración de Wazuh con MISP para Threat Intelligence: Guía práctica para implementación empresarial en Wazuh"
  publishDate="2025-12-03"
  author="AI Security"
  readTime="8 min"
  tags={["MISP", "threat intelligence", "IOC", "indicators of compromise", "Wazuh", "Ciberseguridad"]}
  canonical="https://aisecurity.es/blog/integracion-de-wazuh-con-misp-para-threat-intelligence">

<p>Las organizaciones luchan por reaccionar rápidamente ante nuevas amenazas debido a la inteligencia de amenazas fragmentada. La integración de <strong>Wazuh</strong> con <strong>MISP</strong> automatiza la ingesta de Indicadores de Compromiso (IOCs) y permite la detección de amenazas en tiempo real, fortaleciendo la postura de ciberseguridad.</p>

<h2>Caso de uso empresarial</h2>
<p>Imagine que el CISO de una empresa recibe una alerta sobre una nueva campaña de malware (por ejemplo, un nuevo tipo de ransomware o phishing). Esta información, incluyendo IOCs como IPs maliciosas, dominios de C2 y hashes de archivos, se comparte a través de ISACs (Information Sharing and Analysis Centers) o feeds de inteligencia de amenazas. Actualizar manualmente cada sistema de seguridad con estos nuevos IOCs es lento y propenso a errores, dejando una ventana de oportunidad para los atacantes. Con la integración de Wazuh y MISP, los nuevos IOCs se sincronizan automáticamente con Wazuh, asegurando que todos los endpoints y servidores supervisados puedan detectar y alertar sobre estas amenazas de inmediato, cerrando esa ventana de riesgo y permitiendo una respuesta proactiva.</p>

<h2>Requisitos previos</h2>
<ul>
    <li><strong>Wazuh Manager:</strong> Versión 4.x o superior instalada y operativa.</li>
    <li><strong>MISP:</strong> Instancia de MISP (2.4.x o superior) instalada y operativa, con una clave API generada.</li>
    <li><strong>Python 3:</strong> Instalado en el servidor Wazuh Manager.</li>
    <li><strong>pip:</strong> Gestor de paquetes de Python.</li>
    <li>Acceso de red desde el Wazuh Manager a la instancia de MISP.</li>
</ul>

<h2>Instalación/Configuración</h2>

<h3>1. Instalar dependencias de Python en el Wazuh Manager</h3>
<p>Acceda a su servidor Wazuh Manager y ejecute los siguientes comandos para instalar las bibliotecas necesarias para interactuar con MISP:</p>
<pre><code class="language-bash">pip install pymisp requests</code></pre>
<p>Este comando instala <code>pymisp</code> para la comunicación con la API de MISP y <code>requests</code>, una biblioteca HTTP esencial.</p>

<h3>2. Crear un script Python para la sincronización de IOCs</h3>
<p>Cree un archivo llamado <code>misp-sync.py</code> en el directorio de integraciones de Wazuh. Este script se encargará de consultar MISP y actualizar una lista de IOCs para Wazuh.</p>
<pre><code class="language-bash">sudo mkdir -p /var/ossec/integrations/
sudo nano /var/ossec/integrations/misp-sync.py</code></pre>
<p>Pegue el siguiente contenido, reemplazando <code>YOUR_MISP_URL_HERE</code> y <code>YOUR_MISP_API_KEY_HERE</code> con sus credenciales de MISP:</p>
<pre><code class="language-python">#!/usr/bin/env python3

from pymisp import PyMISP
from pymisp.exceptions import PyMISPError
import os
import sys

# --- MISP Configuration ---
MISP_URL = 'YOUR_MISP_URL_HERE'  # e.g., 'https://misp.example.com'
MISP_KEY = 'YOUR_MISP_API_KEY_HERE'
MISP_VERIFY_CERT = True # Set to False if you have self-signed certs and don't verify

# --- Wazuh Configuration ---
# Esta lista almacenará principalmente direcciones IP para IOCs basados en red
WAZUH_IP_IOC_LIST_PATH = '/var/ossec/etc/lists/misp_ip_iocs'

def fetch_and_write_ip_iocs():
    try:
        misp = PyMISP(MISP_URL, MISP_KEY, MISP_VERIFY_CERT)
    except PyMISPError as e:
        print(f"Error al inicializar PyMISP: {"{"{"}"}e{"}"}", file=sys.stderr)
        return

    print("Obteniendo eventos de MISP para IOCs de IP...")
    try:
        # Obtener eventos de las últimas 24 horas, enfocándose en atributos de IP
        events = misp.search(last="1d", type_attribute=['ip-src', 'ip-dst'])
    except PyMISPError as e:
        print(f"Error al buscar eventos de MISP: {"{"{"}"}e{"}"}", file=sys.stderr)
        return

    ip_iocs = set()
    for event in events:
        if 'Attribute' in event:
            for attr in event['Attribute']:
                attr_type = attr.get('type')
                attr_value = attr.get('value')
                
                if attr_value and attr_type in ['ip-src', 'ip-dst']:
                    ip_iocs.add(attr_value)

    if not ip_iocs:
        print("No se encontraron nuevos IOCs de IP en MISP.")
        return

    try:
        # Sobreescribir el archivo para asegurar que la lista esté siempre actualizada
        with open(WAZUH_IP_IOC_LIST_PATH, 'w') as f:
            for ioc in sorted(list(ip_iocs)):
                f.write(f"{"{"{"}"}ioc{"}"}\n")
        print(f"Se escribieron correctamente {"{"{"}"}len(ip_iocs){"}"} IOCs de IP en {"{"{"}"}WAZUH_IP_IOC_LIST_PATH{"}"}")
        
    except IOError as e:
        print(f"Error al escribir IOCs de IP en el archivo {"{"{"}"}WAZUH_IP_IOC_LIST_PATH{"}"}: {"{"{"}"}e{"}"}", file=sys.stderr)

if __name__ == '__main__':
    fetch_and_write_ip_iocs()</code></pre>
<p>Haga que el script sea ejecutable:</p>
<pre><code class="language-bash">sudo chmod +x /var/ossec/integrations/misp-sync.py</code></pre>

<h3>3. Configurar el archivo ossec.conf de Wazuh</h3>
<p>Edite el archivo de configuración principal de Wazuh para incluir la nueva lista de IOCs. Esto permitirá que Wazuh use esta lista en sus reglas.</p>
<pre><code class="language-bash">sudo nano /var/ossec/etc/ossec.conf</code></pre>
<p>Dentro de la sección <code>&lt;ruleset&gt;</code>, añada la siguiente entrada de lista:</p>
<pre><code class="language-xml">  &lt;ruleset&gt;
    &lt;!-- ... otras configuraciones de ruleset ... --&gt;

    &lt;list&gt;
      &lt;file&gt;etc/lists/misp_ip_iocs&lt;/file&gt;
      &lt;addon&gt;address_match_list&lt;/addon&gt;
    &lt;/list&gt;

    &lt;!-- ... otras configuraciones de ruleset ... --&gt;
  &lt;/ruleset&gt;</code></pre>
<p>La etiqueta <code>&lt;addon&gt;address_match_list&lt;/addon&gt;</code> optimiza la búsqueda de IPs en la lista.</p>

<h3>4. Crear reglas personalizadas en Wazuh</h3>
<p>Cree reglas personalizadas en <code>/var/ossec/etc/rules/local_rules.xml</code> para detectar coincidencias con los IOCs. Estas reglas se activarán cuando se detecte una IP de la lista MISP en los logs.</p>
<pre><code class="language-bash">sudo nano /var/ossec/etc/rules/local_rules.xml</code></pre>
<p>Añada las siguientes reglas:</p>
<pre><code class="language-xml">&lt;group name="misp_threat_intelligence,"&gt;

  &lt;!-- Regla para detectar IP de origen maliciosa --&gt;
  &lt;rule id="100001" level="10"&gt;
    &lt;if_sid&gt;30000&lt;/if_sid&gt; &lt;!-- ID de regla de ejemplo para logs que contengan IP de origen. Adapte según su caso (e.g., firewall, web server) --&gt;
    &lt;field name="srcip" type="check_list"&gt;etc/lists/misp_ip_iocs&lt;/field&gt;
    &lt;description&gt;MISP Threat Intelligence: IP de origen detectada como maliciosa por MISP.&lt;/description&gt;
    &lt;group&gt;attack,gpl_attack,pci_dss_10.2.4,pci_dss_10.6.1,gdpr_IV.35.7.d,nist_800-53_AU.6,nist_800-53_SI.4,ospp_aud.1,hipaa_164.312.b,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3&lt;/group&gt;
  &lt;/rule&gt;

  &lt;!-- Regla para detectar IP de destino maliciosa --&gt;
  &lt;rule id="100002" level="10"&gt;
    &lt;if_sid&gt;30000&lt;/if_sid&gt; &lt;!-- ID de regla de ejemplo para logs que contengan IP de destino. Adapte según su caso --&gt;
    &lt;field name="dstip" type="check_list"&gt;etc/lists/misp_ip_iocs&lt;/field&gt;
    &lt;description&gt;MISP Threat Intelligence: IP de destino detectada como maliciosa por MISP.&lt;/description&gt;
    &lt;group&gt;attack,gpl_attack,pci_dss_10.2.4,pci_dss_10.6.1,gdpr_IV.35.7.d,nist_800-53_AU.6,nist_800-53_SI.4,ospp_aud.1,hipaa_164.312.b,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3&lt;/group&gt;
  &lt;/rule&gt;

&lt;/group&gt;</code></pre>
<p><strong>Nota:</strong> El <code>&lt;if_sid&gt;30000&lt;/if_sid&gt;</code> es un ejemplo. Debe identificar las IDs de reglas apropiadas para los logs de sus fuentes de datos (firewalls, servidores web, sistemas operativos) que contengan IPs de origen o destino.</p>

<h3>5. Programar la sincronización automática</h3>
<p>Utilice <code>cron</code> para ejecutar el script de sincronización periódicamente, manteniendo la lista de IOCs actualizada en Wazuh.</p>
<pre><code class="language-bash">sudo crontab -e</code></pre>
<p>Añada la siguiente línea para ejecutar el script cada 15 minutos (ajuste la frecuencia según sus necesidades):</p>
<pre><code class="language-bash">*/15 * * * * /usr/bin/python3 /var/ossec/integrations/misp-sync.py &gt; /dev/null 2&gt;&amp;1</code></pre>

<h3>6. Reiniciar el Wazuh Manager</h3>
<p>Para aplicar todos los cambios de configuración, reinicie el servicio del Wazuh Manager:</p>
<pre><code class="language-bash">sudo systemctl restart wazuh-manager</code></pre>

<h2>Ejemplo práctico</h2>

<h3>1. Simular un IOC en MISP</h3>
<p>En su instancia de MISP, cree un nuevo evento y añada un atributo de tipo <code>ip-src</code> o <code>ip-dst</code> con una IP de prueba, por ejemplo, <code>1.2.3.4</code>. Asegúrese de publicar el evento.</p>

<h3>2. Ejecutar la sincronización manualmente</h3>
<p>En el Wazuh Manager, ejecute el script de sincronización para obtener la nueva IP:</p>
<pre><code class="language-bash">sudo /var/ossec/integrations/misp-sync.py</code></pre>
<p>Debería ver un mensaje similar a:</p>
<pre><code class="language-bash">Obteniendo eventos de MISP para IOCs de IP...
Se escribieron correctamente X IOCs de IP en /var/ossec/etc/lists/misp_ip_iocs</code></pre>

<h3>3. Verificar la lista de IOCs en Wazuh</h3>
<p>Confirme que la IP de prueba ha sido añadida a la lista de Wazuh:</p>
<pre><code class="language-bash">cat /var/ossec/etc/lists/misp_ip_iocs | grep "1.2.3.4"</code></pre>
<p><strong>Output esperado:</strong></p>
<pre><code class="language-bash">1.2.3.4</code></pre>

<h3>4. Simular un log que dispara la regla</h3>
<p>Ahora, simule un log de sistema que contenga esta IP maliciosa. Ejecute esto en un agente Wazuh o directamente en el Manager si está simulando logs de un agente:</p>
<pre><code class="language-bash">logger -p local0.info "Conexión entrante desde la IP sospechosa 1.2.3.4 al puerto 80"</code></pre>

<h3>5. Verificar la alerta en Wazuh</h3>
<p>Verifique los logs de alertas de Wazuh para confirmar que se generó una alerta con ID <code>100001</code> o <code>100002</code>:</p>
<pre><code class="language-bash">tail -f /var/ossec/logs/alerts/alerts.json | grep "1.2.3.4"</code></pre>
<p><strong>Output esperado (fragmento):</strong></p>
<pre><code class="language-json">{"{"{"}"}
  "rule": {"{"{"}"}
    "level": 10,
    "description": "MISP Threat Intelligence: IP de origen detectada como maliciosa por MISP.",
    "id": "100001",
    "firedtimes": 1,
    "mail": false,
    "groups": ["misp_threat_intelligence", "attack", "gpl_attack"]
  {"}"},
  "location": "hostname->/var/log/syslog",
  "agent": {"{"{"}"}
    "id": "000",
    "name": "wazuh-manager"
  {"}"},
  "syslog": {"{"{"}"}
    "program": "local0",
    "timestamp": "Jul 15 10:30:00",
    "full_log": "Jul 15 10:30:00 hostname local0.info: Conexión entrante desde la IP sospechosa 1.2.3.4 al puerto 80",
    "srcip": "1.2.3.4"
  {"}"},
  "timestamp": "2023-07-15T10:30:00.000+0000"
{"}"}</code></pre>
<p>Esta alerta confirma que Wazuh ha detectado la IP maliciosa de MISP en un log del sistema.</p>

<h2>Conclusión</h2>
<p>La integración de Wazuh con MISP establece un flujo de trabajo de inteligencia de amenazas automatizado, permitiendo que su infraestructura de seguridad reaccione instantáneamente a los nuevos IOCs. Esta capacidad reduce significativamente el tiempo de detección y respuesta ante amenazas, liberando a su equipo de operaciones de seguridad de tareas manuales repetitivas y permitiéndoles centrarse en la remediación y análisis avanzado. Al mantener sus defensas actualizadas con la inteligencia de amenazas más reciente, usted fortalece la postura de seguridad de su organización de manera proactiva.</p>
<p>Para implementar esta solución en su entorno o explorar otras capacidades de Wazuh y la inteligencia de amenazas, contáctenos para una <a href="/reunion">reunión</a> y demostración personalizada.</p>

  <hr />

  <p class="text-sm text-base-600">
    <strong>¿Necesitas implementar esta solución?</strong> <a href="/reunion">Solicita una consulta gratuita aquí</a>.
  </p>
</BlogLayout>
