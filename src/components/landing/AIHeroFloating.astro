---
// Tarjetas con posiciones finales - se expanden desde el centro hacia afuera
// vertical: true = tarjeta en formato vertical (rotate 90deg)
const cards = [
  // Par 1: Arriba — izq / der (y: -40)
  { id: 1, src: '/images/intro/a1.png', x: -40, y: -40, rotateY: -15, finalScale: 0.45, vertical: false, label: 'Recepcionista IA', href: '/servicios/atencion-llamadas' },
  { id: 2, src: '/images/intro/a2.png', x: 40, y: -40, rotateY: 15, finalScale: 0.45, vertical: false, label: 'Agenda tu Reunión', href: '/reunion' },
  // Par 2: Arriba lejos — izq / der (y: -32)
  { id: 9, src: '/images/intro/a9.png', x: -62, y: -32, rotateY: -10, finalScale: 0.30, vertical: false, label: 'Curso Wazuh', href: '/curso-wazuh' },
  { id: 10, src: '/images/intro/a10.png', x: 62, y: -32, rotateY: 10, finalScale: 0.30, vertical: false, label: 'Soporte IT', href: '/servicios/desarrollo-web' },
  // Par 3: Centro — izq / der (y: -5)
  { id: 4, src: '/images/intro/a4.png', x: -55, y: -5, rotateY: -20, finalScale: 0.48, vertical: false, label: 'Soporte IT', href: '/servicios/desarrollo-web' },
  { id: 5, src: '/images/intro/a5.png', x: 55, y: -5, rotateY: 20, finalScale: 0.48, vertical: false, label: 'Desarrollo Web', href: '/servicios/desarrollo-web' },
  // Par 4: Centro vertical — izq / der (y: 5)
  { id: 13, src: '/images/intro/a13.png', x: -48, y: 5, rotateY: -18, finalScale: 0.44, vertical: true, label: 'Automatización IA', href: '/servicios/automatizacion' },
  { id: 14, src: '/images/intro/a14.png', x: 48, y: 5, rotateY: 18, finalScale: 0.44, vertical: true, label: 'Chatbot Inteligente', href: '/servicios/chatbot' },
  // Par 5: Abajo — izq / der (y: 38)
  { id: 6, src: '/images/intro/a6.png', x: -42, y: 38, rotateY: -14, finalScale: 0.40, vertical: false, label: 'Wazuh SIEM', href: '/wazuh' },
  { id: 3, src: '/images/intro/a3.png', x: 42, y: 38, rotateY: 14, finalScale: 0.40, vertical: false, label: 'Gestor Documental', href: '/servicios/gestor-documental' },
  // Par 6: Abajo lejos — izq / der (y: 45)
  { id: 11, src: '/images/intro/a11.png', x: -58, y: 45, rotateY: -8, finalScale: 0.28, vertical: false, label: 'Blog', href: '/blog' },
  { id: 12, src: '/images/intro/a12.png', x: 58, y: 45, rotateY: 8, finalScale: 0.28, vertical: false, label: 'Automatización IA', href: '/servicios/automatizacion' },
  // Par 7: Pegadas al box central — salen las últimas, una a cada lado
  { id: 7, src: '/images/intro/a7.png', x: -34, y: 3, rotateY: -6, finalScale: 0.42, vertical: false, label: 'Wazuh SIEM', href: '/wazuh' },
  { id: 8, src: '/images/intro/a8.png', x: 34, y: 3, rotateY: 6, finalScale: 0.42, vertical: false, label: 'Wazuh SIEM', href: '/wazuh' },
];
---

<section class="relative min-h-screen overflow-hidden" style="background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #0f0f1a 100%);">
  <!-- Background Image -->
  <div class="absolute inset-0">
    <img src="/images/6107094.jpg" alt="" class="w-full h-full object-cover opacity-10" aria-hidden="true" />
  </div>
  <!-- Floating Cards Container - ABOVE background, BELOW interactive content -->
  <!-- Dos oleadas de tarjetas desfasadas 12s para solapar 3s entre ciclos -->
  <div class="floating-cards-container absolute inset-0" style="z-index: 5; perspective: 1200px;">
    {/* Oleada 1: delay normal */}
    {cards.map((card, index) => (
      <div
        class={`floating-card absolute rounded-xl overflow-hidden ${card.vertical ? 'vertical-card' : ''}`}
        data-href={card.href}
        style={`
          left: 50%;
          top: 50%;
          --final-x: ${card.x}vw;
          --final-y: ${card.y}vh;
          --final-ry: ${card.rotateY}deg;
          --final-scale: ${card.finalScale};
          --delay: 0s;
          width: 420px;
          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6), 0 0 40px rgba(59, 130, 246, 0.15);
          border: 1px solid rgba(255, 255, 255, 0.15);
        `}
      >
        <img
          src={card.src}
          alt={card.label}
          class="w-full h-auto"
          loading="eager"
        />
        <span class="card-label">{card.label}</span>
      </div>
    ))}
    {/* Oleada 2: misma animación pero desfasada 12s (solapamiento de 3s) */}
    {cards.map((card, index) => (
      <div
        class={`floating-card absolute rounded-xl overflow-hidden ${card.vertical ? 'vertical-card' : ''}`}
        data-href={card.href}
        style={`
          left: 50%;
          top: 50%;
          --final-x: ${card.x}vw;
          --final-y: ${card.y}vh;
          --final-ry: ${card.rotateY}deg;
          --final-scale: ${card.finalScale};
          --delay: 12s;
          width: 420px;
          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.6), 0 0 40px rgba(59, 130, 246, 0.15);
          border: 1px solid rgba(255, 255, 255, 0.15);
        `}
      >
        <img
          src={card.src}
          alt={card.label}
          class="w-full h-auto"
          loading="eager"
        />
        <span class="card-label">{card.label}</span>
      </div>
    ))}
  </div>

  <!-- Central Content Box - ABOVE cards -->
  <div class="relative min-h-screen flex items-center justify-center px-4 sm:px-6" style="opacity:90%; z-index: 10; pointer-events: none;">
    <div  class="hero-box w-full max-w-2xl mx-auto rounded-3xl p-8 md:p-12" style="pointer-events: auto; background: rgba(10, 10, 18, 0.87); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 0 80px rgba(0, 0, 0, 0.6), 0 0 40px rgba(59, 130, 246, 0.08);">
      <!-- Title -->
      <h1 class="hero-title text-3xl sm:text-4xl md:text-5xl font-bold leading-tight tracking-tight mb-4 text-center text-white">
        Automatiza tu negocio con
        <span class="block mt-1 bg-gradient-to-r from-blue-400 via-indigo-400 to-purple-400 bg-clip-text text-transparent">
          Inteligencia Artificial
        </span>
      </h1>

      <!-- Subtitle -->
      <p class="hero-subtitle text-base md:text-lg mb-8 max-w-xl mx-auto text-center text-gray-300">
        Cuéntanos qué quieres automatizar en tu empresa, qué tienes en mente, y te decimos cómo podemos ayudarte.
      </p>

      <!-- Chat Input - Dark Style -->
      <div class="hero-input-container">
        <form id="chat-form" class="relative">
          <div class="chat-input-wrapper rounded-2xl px-2 py-1.5 transition-all" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
            <!-- Respuesta inline (oculta por defecto) -->
            <div id="chat-response" class="hidden px-3 py-3">
              <div id="chat-response-text" class="text-sm text-gray-200 leading-relaxed"></div>
              <!-- Email contact mini-form -->
              <div id="email-contact" class="mt-3 pt-3" style="border-top: 1px solid rgba(255, 255, 255, 0.08);">
                <p class="text-xs text-gray-400 mb-2">¿Quieres que te respondamos con más detalle?</p>
                <div id="email-input-row" class="flex items-center gap-2">
                  <input
                    type="email"
                    id="email-input"
                    placeholder="Tu email..."
                    class="flex-1 bg-transparent px-3 py-1.5 text-sm text-white placeholder-gray-500 focus:outline-none rounded-lg"
                    style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);"
                  />
                  <button type="button" id="email-send" class="px-3 py-1.5 text-xs font-medium text-white rounded-lg transition-colors" style="background: #2563eb;">
                    Enviar
                  </button>
                </div>
                <p id="email-success" class="hidden text-xs text-green-400 mt-2">✓ Recibido. Te contestaremos lo antes posible.</p>
                <p id="email-error" class="hidden text-xs text-red-400 mt-2">Error al enviar. Prueba en info@aisecurity.es</p>
              </div>
              <button type="button" id="chat-back" class="mt-3 flex items-center gap-1.5 text-xs text-blue-400 hover:text-blue-300 transition-colors">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Nueva pregunta
              </button>
            </div>
            <!-- Input row -->
            <div id="chat-input-row" class="flex items-center">
              <input
                type="text"
                id="chat-input"
                placeholder="Pregunta sobre nuestros servicios de IA..."
                class="flex-1 bg-transparent px-3 py-2.5 text-white placeholder-gray-500 focus:outline-none text-base"
              />
              <!-- Send button -->
              <button
                type="submit"
                id="chat-submit"
                class="p-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-xl transition-colors flex items-center justify-center"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                </svg>
              </button>
            </div>
            <!-- Typing indicator (oculto) -->
            <div id="chat-typing" class="hidden px-3 py-3">
              <div class="flex gap-1.5 items-center">
                <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div>
                <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div>
                <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div>
                <span class="text-xs text-gray-500 ml-2">Pensando...</span>
              </div>
            </div>
          </div>
        </form>

        <!-- Quick suggestion buttons -->
        <div id="quick-buttons" class="flex flex-wrap gap-2 mt-5 justify-center">
          <button class="quick-question flex items-center gap-2 px-4 py-2 text-sm rounded-full text-gray-300 transition-all hover:text-white" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
            <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
            ¿Cuánto cuesta crear una página web nueva?
          </button>
          <button class="quick-question flex items-center gap-2 px-4 py-2 text-sm rounded-full text-gray-300 transition-all hover:text-white" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
            <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            ¿Qué podría automatizar en mi empresa?
          </button>
          <button class="quick-question flex items-center gap-2 px-4 py-2 text-sm rounded-full text-gray-300 transition-all hover:text-white" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
            <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
            ¿Qué es Wazuh?
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scroll Indicator -->
  <div class="absolute bottom-8 left-1/2 -translate-x-1/2" style="z-index: 20;">
    <div class="flex flex-col items-center gap-2 text-gray-400 animate-bounce">
      <span class="text-xs font-medium">Descubre más</span>
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
      </svg>
    </div>
  </div>
</section>

<style>
  /* Animation: 15s ciclo. Tarjetas van de centro hacia afuera, fade in/out.
     Se duplican con offset de 12s para solapar 3s entre oleadas. */
  @keyframes expandToward {
    0% {
      opacity: 0;
      filter: blur(8px);
      transform: translate(-50%, -50%) translateX(0vw) translateY(0vh) rotateY(0deg) scale(0.05);
    }
    3% {
      opacity: 0.5;
      filter: blur(6px);
      transform: translate(-50%, -50%) translateX(calc(var(--final-x) * 0.03)) translateY(calc(var(--final-y) * 0.03)) rotateY(calc(var(--final-ry) * 0.03)) scale(0.07);
    }
    20% {
      opacity: 0.7;
      filter: blur(3px);
      transform: translate(-50%, -50%) translateX(calc(var(--final-x) * 0.2)) translateY(calc(var(--final-y) * 0.2)) rotateY(calc(var(--final-ry) * 0.2)) scale(0.22);
    }
    40% {
      opacity: 0.9;
      filter: blur(0px);
      transform: translate(-50%, -50%) translateX(calc(var(--final-x) * 0.4)) translateY(calc(var(--final-y) * 0.4)) rotateY(calc(var(--final-ry) * 0.4)) scale(0.42);
    }
    55% {
      opacity: 0.85;
      filter: blur(0px);
      transform: translate(-50%, -50%) translateX(calc(var(--final-x) * 0.55)) translateY(calc(var(--final-y) * 0.55)) rotateY(calc(var(--final-ry) * 0.55)) scale(0.6);
    }
    70% {
      opacity: 0.7;
      filter: blur(0px);
      transform: translate(-50%, -50%) translateX(calc(var(--final-x) * 0.7)) translateY(calc(var(--final-y) * 0.7)) rotateY(calc(var(--final-ry) * 0.7)) scale(0.78);
    }
    85% {
      opacity: 0.35;
      filter: blur(1px);
      transform: translate(-50%, -50%) translateX(calc(var(--final-x) * 0.85)) translateY(calc(var(--final-y) * 0.85)) rotateY(calc(var(--final-ry) * 0.85)) scale(0.95);
    }
    95% {
      opacity: 0.1;
      filter: blur(3px);
      transform: translate(-50%, -50%) translateX(calc(var(--final-x) * 0.97)) translateY(calc(var(--final-y) * 0.97)) rotateY(calc(var(--final-ry) * 0.97)) scale(1.1);
    }
    100% {
      opacity: 0;
      filter: blur(5px);
      transform: translate(-50%, -50%) translateX(calc(var(--final-x) * 1.05)) translateY(calc(var(--final-y) * 1.05)) rotateY(var(--final-ry)) scale(1.2);
    }
  }

  .floating-card {
    will-change: transform, opacity, filter;
    animation: expandToward 15s linear infinite;
    animation-delay: var(--delay);
    opacity: 0;
    cursor: pointer;
    pointer-events: auto;
    transition: box-shadow 0.3s ease, border-color 0.3s ease;
  }

  /* Hover: solo pausa */
  .floating-card.paused {
    animation-play-state: paused !important;
    box-shadow: 0 25px 60px -12px rgba(59, 130, 246, 0.3), 0 0 50px rgba(59, 130, 246, 0.2) !important;
    border-color: rgba(99, 102, 241, 0.4) !important;
  }

  /* Click: se agranda, endereza y se ilumina */
  .floating-card.expanded {
    animation: none !important;
    opacity: 1 !important;
    filter: blur(0px) brightness(1.15) !important;
    box-shadow: 0 25px 60px -12px rgba(59, 130, 246, 0.4), 0 0 60px rgba(59, 130, 246, 0.25), 0 0 120px rgba(99, 102, 241, 0.15) !important;
    border-color: rgba(99, 102, 241, 0.5) !important;
    z-index: 50;
    transition: transform 0.4s ease, box-shadow 0.3s ease, border-color 0.3s ease, filter 0.3s ease, opacity 0.2s ease;
  }

  /* Label que aparece en hover/paused debajo de la imagen */
  .card-label {
    display: block;
    width: 100%;
    text-align: center;
    padding: 6px 12px;
    font-size: 13px;
    font-weight: 600;
    color: white;
    background: linear-gradient(180deg, rgba(10, 10, 30, 0.85) 0%, rgba(30, 30, 80, 0.95) 100%);
    opacity: 0;
    transform: translateY(100%);
    transition: opacity 0.3s ease, transform 0.3s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    letter-spacing: 0.02em;
  }

  .floating-card.paused .card-label,
  .floating-card.expanded .card-label {
    opacity: 1;
    transform: translateY(0);
  }

  .vertical-card {
    width: 240px !important;
    aspect-ratio: 9 / 16;
    object-fit: cover;
  }

  .vertical-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: top;
  }

  /* Hero content fade in */
  .hero-title {
    animation: fadeInUp 0.8s ease-out both;
  }

  .hero-subtitle {
    animation: fadeInUp 0.8s ease-out 0.15s both;
  }

  .hero-input-container {
    animation: fadeInUp 0.8s ease-out 0.3s both;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Input focus state */
  .chat-input-wrapper:focus-within {
    background: rgba(255, 255, 255, 0.08) !important;
    border-color: rgba(59, 130, 246, 0.5) !important;
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.15);
  }

  /* Quick question hover */
  .quick-question:hover {
    background: rgba(255, 255, 255, 0.1) !important;
    border-color: rgba(255, 255, 255, 0.2) !important;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .floating-card {
      width: 220px !important;
    }

    .floating-cards-container {
      opacity: 0.5;
    }
  }

  @media (max-width: 640px) {
    .floating-card {
      width: 150px !important;
    }

    .floating-cards-container {
      opacity: 0.35;
    }

    .quick-question {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
    }

    .quick-question svg {
      width: 0.875rem;
      height: 0.875rem;
    }
  }
</style>

<script>
  // Chat inline: respuesta dentro de la misma caja del input
  const chatForm = document.getElementById('chat-form');
  const chatInput = document.getElementById('chat-input') as HTMLInputElement;
  const chatInputRow = document.getElementById('chat-input-row');
  const chatResponse = document.getElementById('chat-response');
  const chatResponseText = document.getElementById('chat-response-text');
  const chatTyping = document.getElementById('chat-typing');
  const chatBack = document.getElementById('chat-back');
  const quickButtons = document.getElementById('quick-buttons');
  const quickQuestions = document.querySelectorAll('.quick-question');

  // Email contact elements
  const emailInput = document.getElementById('email-input') as HTMLInputElement;
  const emailSend = document.getElementById('email-send');
  const emailContact = document.getElementById('email-contact');
  const emailSuccess = document.getElementById('email-success');
  const emailError = document.getElementById('email-error');
  const emailInputRow = document.getElementById('email-input-row');

  // Track current conversation for email
  let lastQuestion = '';
  let lastReply = '';

  // Mostrar estado: input, typing o respuesta
  function showInput() {
    chatInputRow!.classList.remove('hidden');
    chatTyping!.classList.add('hidden');
    chatResponse!.classList.add('hidden');
    quickButtons!.classList.remove('hidden');
    chatInput.value = '';
    chatInput.focus();
    // Reset email form state
    emailInput.value = '';
    emailInputRow!.classList.remove('hidden');
    emailSuccess!.classList.add('hidden');
    emailError!.classList.add('hidden');
    (document.querySelector('#email-contact p:first-child') as HTMLElement)?.classList.remove('hidden');
  }

  function showTyping() {
    chatInputRow!.classList.add('hidden');
    chatTyping!.classList.remove('hidden');
    chatResponse!.classList.add('hidden');
    quickButtons!.classList.add('hidden');
  }

  // Convierte rutas del sitio en enlaces clicables
  function linkifyPaths(text: string): string {
    return text.replace(/(\/(?:contacto-migracion|contacto|reunion|wazuh|curso-wazuh|blog|servicios\/chatbot|servicios\/gestor-documental|servicios\/gestor-citas|servicios\/atencion-llamadas|servicios\/automatizacion|servicios\/desarrollo-web))/g,
      '<a href="$1" style="color: #60a5fa; text-decoration: underline; cursor: pointer;">$1</a>'
    );
  }

  function showResponse(text: string) {
    chatInputRow!.classList.add('hidden');
    chatTyping!.classList.add('hidden');
    chatResponse!.classList.remove('hidden');
    chatResponseText!.innerHTML = linkifyPaths(text);
    quickButtons!.classList.add('hidden');
  }

  // Enviar mensaje a la API
  async function sendMessage(message: string) {
    lastQuestion = message;
    showTyping();

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });

      if (response.ok) {
        const data = await response.json();
        lastReply = data.reply;
        showResponse(data.reply);
      } else {
        showResponse('Lo siento, hubo un error. Contacta con nosotros en info@aisecurity.es');
      }
    } catch (error) {
      showResponse('Error de conexión. Intenta de nuevo.');
    }
  }

  // Form submit
  chatForm?.addEventListener('submit', (e) => {
    e.preventDefault();
    const message = chatInput?.value.trim();
    if (message) {
      sendMessage(message);
    }
  });

  // Quick question buttons
  quickQuestions.forEach(btn => {
    btn.addEventListener('click', () => {
      const question = btn.textContent?.trim();
      if (question) sendMessage(question);
    });
  });

  // Botón "Nueva pregunta" vuelve al input
  chatBack?.addEventListener('click', () => {
    showInput();
  });

  // Email send button
  emailSend?.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    if (!email || !email.includes('@')) {
      emailInput.style.borderColor = 'rgba(239, 68, 68, 0.5)';
      setTimeout(() => { emailInput.style.borderColor = 'rgba(255, 255, 255, 0.1)'; }, 2000);
      return;
    }

    emailSend.textContent = '...';
    (emailSend as HTMLButtonElement).disabled = true;

    try {
      const res = await fetch('/api/chat-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, question: lastQuestion, reply: lastReply })
      });

      if (res.ok) {
        emailInputRow!.classList.add('hidden');
        (document.querySelector('#email-contact p:first-child') as HTMLElement)?.classList.add('hidden');
        emailSuccess!.classList.remove('hidden');
      } else {
        emailError!.classList.remove('hidden');
      }
    } catch {
      emailError!.classList.remove('hidden');
    } finally {
      emailSend.textContent = 'Enviar';
      (emailSend as HTMLButtonElement).disabled = false;
    }
  });

  // Allow Enter key in email input
  emailInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      emailSend?.click();
    }
  });

  // Floating card: hover = pause, click = expand (all pause, click again resumes all)
  const floatingCards = document.querySelectorAll('.floating-card');
  let expandedCard: HTMLElement | null = null;
  let expandedPosX = 0;
  let expandedPosY = 0;

  // Pausa TODAS las tarjetas (excepto la expandida que usa animation:none)
  function pauseAllCards() {
    floatingCards.forEach(c => {
      const card = c as HTMLElement;
      if (card !== expandedCard) {
        card.classList.add('paused');
      }
    });
  }

  // Reanuda TODAS las tarjetas
  function resumeAllCards() {
    floatingCards.forEach(c => {
      (c as HTMLElement).classList.remove('paused');
    });
  }

  function collapseExpanded() {
    if (!expandedCard) return;
    const el = expandedCard;
    // Animar de vuelta a tamaño normal en la misma posición
    el.style.transform = `translate(${expandedPosX}px, ${expandedPosY}px) scale(1)`;
    setTimeout(() => {
      el.classList.remove('expanded');
      el.style.transform = '';
      // La animación CSS se reanuda automáticamente al quitar .expanded
    }, 400);
    expandedCard = null;
    // Reanudar todas las demás
    resumeAllCards();
  }

  floatingCards.forEach(card => {
    const el = card as HTMLElement;

    // Hover: solo pausa la animación de esa tarjeta (si no hay ninguna expandida)
    el.addEventListener('mouseenter', () => {
      if (!expandedCard && !el.classList.contains('expanded')) {
        el.classList.add('paused');
      }
    });

    el.addEventListener('mouseleave', () => {
      if (!expandedCard) {
        el.classList.remove('paused');
      }
    });

    // Click: 1er click = expandir, 2do click = navegar al servicio
    el.addEventListener('click', () => {
      if (el.classList.contains('expanded')) {
        // Ya expandida → navegar al enlace del servicio
        const href = el.dataset.href;
        if (href) {
          window.location.href = href;
        }
        return;
      }

      // Si hay otra expandida, colapsar primero
      collapseExpanded();

      // Capturar posición actual
      const computed = getComputedStyle(el);
      const matrix = new DOMMatrix(computed.transform);
      expandedPosX = matrix.m41;
      expandedPosY = matrix.m42;

      // Pausar TODAS las demás tarjetas
      pauseAllCards();

      // Fijar posición de la clickada, quitar paused
      el.classList.remove('paused');
      el.style.transform = `translate(${expandedPosX}px, ${expandedPosY}px) scale(1)`;
      el.classList.add('expanded');

      // Animar a recta y más grande
      requestAnimationFrame(() => {
        el.style.transform = `translate(${expandedPosX}px, ${expandedPosY}px) rotateY(0deg) scale(1.25)`;
      });

      expandedCard = el;
    });
  });

  // Click fuera cierra la tarjeta expandida y reanuda todas
  document.addEventListener('click', (e) => {
    if (expandedCard && !expandedCard.contains(e.target as Node)) {
      collapseExpanded();
    }
  });
</script>
