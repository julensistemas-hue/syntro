---
// Meeting request component with visual calendar
---

<section class="py-20 bg-base-25">
  <div class="max-w-7xl mx-auto px-8 md:px-12 lg:px-24">
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold text-base-900 mb-6">
        <span class="text-[#0052cc]">Agenda tu Reunión</span>
      </h1>
      <p class="text-xl text-base-600 max-w-3xl mx-auto">
        Selecciona fecha y hora para tu consulta gratuita. Te enviaremos un enlace de Google Meet.
      </p>
    </div>

    <!-- Alert Container -->
    <div id="alert-container" class="max-w-5xl mx-auto mb-6 hidden"></div>

    <!-- Two Column Layout -->
    <div class="max-w-6xl mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Calendar View -->
        <div class="bg-base-50 rounded-2xl shadow-xl overflow-hidden border border-base-200">
          <div class="bg-gradient-to-r from-[#0052cc] to-blue-600 px-6 py-4 text-white">
            <h3 class="text-lg font-semibold">Selecciona Fecha y Hora</h3>
            <p class="text-sm opacity-90">Las reuniones duran 2 horas</p>
          </div>

          <div class="p-6">
            <!-- Calendar Header -->
            <div class="flex items-center justify-between mb-6">
              <button id="prev-month" class="p-2 hover:bg-base-100 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <h4 id="calendar-month" class="text-lg font-semibold text-base-900">Loading...</h4>
              <button id="next-month" class="p-2 hover:bg-base-100 rounded-lg transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>

            <!-- Day Headers -->
            <div class="grid grid-cols-7 gap-2 mb-4">
              <div class="text-center text-sm font-medium text-base-500">L</div>
              <div class="text-center text-sm font-medium text-base-500">M</div>
              <div class="text-center text-sm font-medium text-base-500">X</div>
              <div class="text-center text-sm font-medium text-base-500">J</div>
              <div class="text-center text-sm font-medium text-base-500">V</div>
              <div class="text-center text-sm font-medium text-base-500">S</div>
              <div class="text-center text-sm font-medium text-base-500">D</div>
            </div>

            <!-- Calendar Grid -->
            <div class="grid grid-cols-7 gap-2 mb-6" id="calendar-grid">
              <!-- Days will be generated by JavaScript -->
            </div>

            <!-- Time Slots -->
            <div class="pt-6 border-t border-base-200">
              <h5 class="text-sm font-semibold text-base-900 mb-3">Horarios disponibles</h5>

              <div id="time-slots-loading" class="text-center py-8">
                <p class="text-sm text-base-500">Selecciona un día para ver horarios disponibles</p>
              </div>

              <div id="time-slots-container" class="hidden">
                <div id="time-slots-spinner" class="text-center py-4">
                  <div class="inline-flex items-center gap-2 text-accent-600">
                    <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-sm">Verificando disponibilidad...</span>
                  </div>
                </div>

                <div id="time-slots-grid" class="hidden grid grid-cols-2 gap-3">
                  <!-- Time slots will be populated here -->
                </div>

                <div id="time-slots-error" class="hidden text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-3">
                  No hay horarios disponibles para este día
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Booking Form -->
        <div class="bg-base-50 rounded-2xl shadow-xl overflow-hidden border border-base-200">
          <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4 text-white">
            <h3 class="text-lg font-semibold">Tus Datos</h3>
            <p class="text-sm opacity-90">Completa la información para confirmar</p>
          </div>

          <div class="p-6">
            <!-- Selected slot indicator -->
            <div id="selected-slot-indicator" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
              <div class="flex items-center gap-2 text-green-800 text-sm font-medium">
                <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span id="selected-slot-text"></span>
              </div>
            </div>

            <form id="meeting-form" class="space-y-4" method="POST">
              <div>
                <label class="block text-sm font-medium text-base-700 mb-2">Nombre completo *</label>
                <input
                  type="text"
                  name="nombre"
                  required
                  class="w-full px-4 py-3 border border-base-300 rounded-lg focus:ring-2 focus:ring-[#0052cc] focus:border-[#0052cc] bg-base-25"
                  placeholder="Ej: Juan García López"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-base-700 mb-2">Email *</label>
                <input
                  type="email"
                  name="email"
                  required
                  class="w-full px-4 py-3 border border-base-300 rounded-lg focus:ring-2 focus:ring-[#0052cc] focus:border-[#0052cc] bg-base-25"
                  placeholder="tu@empresa.com"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-base-700 mb-2">Teléfono *</label>
                <input
                  type="tel"
                  name="telefono"
                  required
                  class="w-full px-4 py-3 border border-base-300 rounded-lg focus:ring-2 focus:ring-[#0052cc] focus:border-[#0052cc] bg-base-25"
                  placeholder="+34 600 000 000"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-base-700 mb-2">Cuéntanos qué necesitas *</label>
                <textarea
                  name="mensaje"
                  rows="4"
                  required
                  class="w-full px-4 py-3 border border-base-300 rounded-lg focus:ring-2 focus:ring-[#0052cc] focus:border-[#0052cc] bg-base-25"
                  placeholder="Ejemplo: Necesito implementar un chatbot para mi tienda online..."
                ></textarea>
              </div>

              <!-- Hidden fields for selected date/time -->
              <input type="hidden" name="selectedDate" id="selectedDateInput" value="" />
              <input type="hidden" name="selectedTime" id="selectedTimeInput" value="" />

              <button
                type="submit"
                id="submit-button"
                class="w-full px-6 py-4 bg-gradient-to-r from-[#0052cc] to-blue-600 text-white rounded-xl font-semibold hover:from-[#003d99] hover:to-blue-700 transition-all duration-200 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span id="button-text">Confirmar Reunión</span>
                <span id="button-loading" class="hidden">Agendando...</span>
              </button>

              <p class="text-sm text-base-500 text-center">
                Al enviar este formulario, nos autorizas a contactarte sobre nuestros servicios.
              </p>
            </form>

            <!-- Success message -->
            <div id="booking-success" class="hidden space-y-4">
              <!-- Success Badge -->
              <div class="bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl p-6 text-center shadow-xl">
                <div class="text-6xl mb-3">✅</div>
                <h4 class="text-2xl font-bold mb-2">¡Reunión Confirmada!</h4>
                <p id="confirmed-date-time" class="text-green-100 text-lg font-medium"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Info cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-12 max-w-6xl mx-auto">
      <div class="bg-base-50 rounded-xl p-6 text-center border border-base-200">
        <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="font-semibold text-base-900 mb-2">Confirmación Inmediata</h3>
        <p class="text-sm text-base-600">Recibirás la confirmación por email y una invitación de calendario</p>
      </div>

      <div class="bg-base-50 rounded-xl p-6 text-center border border-base-200">
        <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
          </svg>
        </div>
        <h3 class="font-semibold text-base-900 mb-2">Reunión Online</h3>
        <p class="text-sm text-base-600">Videollamada desde donde estés, sin desplazamientos</p>
      </div>

      <div class="bg-base-50 rounded-xl p-6 text-center border border-base-200">
        <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        <h3 class="font-semibold text-base-900 mb-2">2 Horas de Consulta</h3>
        <p class="text-sm text-base-600">Tiempo suficiente para analizar tu proyecto en detalle</p>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const calendarGrid = document.getElementById('calendar-grid') as HTMLDivElement;
    const calendarMonth = document.getElementById('calendar-month') as HTMLHeadingElement;
    const prevMonthBtn = document.getElementById('prev-month') as HTMLButtonElement;
    const nextMonthBtn = document.getElementById('next-month') as HTMLButtonElement;

    const timeSlotsLoading = document.getElementById('time-slots-loading') as HTMLDivElement;
    const timeSlotsContainer = document.getElementById('time-slots-container') as HTMLDivElement;
    const timeSlotsSpinner = document.getElementById('time-slots-spinner') as HTMLDivElement;
    const timeSlotsGrid = document.getElementById('time-slots-grid') as HTMLDivElement;
    const timeSlotsError = document.getElementById('time-slots-error') as HTMLDivElement;

    const selectedSlotIndicator = document.getElementById('selected-slot-indicator') as HTMLDivElement;
    const selectedSlotText = document.getElementById('selected-slot-text') as HTMLSpanElement;
    const selectedDateInput = document.getElementById('selectedDateInput') as HTMLInputElement;
    const selectedTimeInput = document.getElementById('selectedTimeInput') as HTMLInputElement;

    const meetingForm = document.getElementById('meeting-form') as HTMLFormElement;
    const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
    const buttonText = document.getElementById('button-text') as HTMLSpanElement;
    const buttonLoading = document.getElementById('button-loading') as HTMLSpanElement;
    const bookingSuccess = document.getElementById('booking-success') as HTMLDivElement;
    const alertContainer = document.getElementById('alert-container') as HTMLDivElement;
    const meetLink = document.getElementById('meet-link') as HTMLAnchorElement;
    const confirmedDateTime = document.getElementById('confirmed-date-time') as HTMLParagraphElement;

    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedDate: Date | null = null;
    let selectedTime: string | null = null;

    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

    function generateCalendar() {
      calendarGrid.innerHTML = '';
      calendarMonth.textContent = `${monthNames[currentMonth]} ${currentYear}`;

      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Add empty cells for days before month starts (Monday = 0)
      const offset = firstDay === 0 ? 6 : firstDay - 1;
      for (let i = 0; i < offset; i++) {
        const emptyDay = document.createElement('div');
        calendarGrid.appendChild(emptyDay);
      }

      // Add days
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        date.setHours(0, 0, 0, 0);

        const dayButton = document.createElement('button');
        dayButton.type = 'button';
        dayButton.textContent = day.toString();
        dayButton.className = 'aspect-square p-2 rounded-lg text-sm font-medium transition-all';

        const isPast = date < today;
        const isToday = date.getTime() === today.getTime();
        const isSelected = selectedDate && date.getTime() === selectedDate.getTime();

        if (isPast) {
          dayButton.className += ' text-base-400 cursor-not-allowed';
          dayButton.disabled = true;
        } else if (isSelected) {
          dayButton.className += ' bg-[#0052cc] text-white';
        } else if (isToday) {
          dayButton.className += ' bg-accent-100 text-accent-700 hover:bg-accent-200';
        } else {
          dayButton.className += ' text-base-700 hover:bg-blue-50 hover:text-[#0052cc]';
        }

        if (!isPast) {
          dayButton.addEventListener('click', () => selectDay(date));
        }

        calendarGrid.appendChild(dayButton);
      }
    }

    async function selectDay(date: Date) {
      selectedDate = date;
      selectedTime = null;
      selectedTimeInput.value = '';
      selectedDateInput.value = date.toISOString().split('T')[0];

      generateCalendar(); // Refresh to show selection

      // Hide initial message, show spinner
      timeSlotsLoading.classList.add('hidden');
      timeSlotsContainer.classList.remove('hidden');
      timeSlotsSpinner.classList.remove('hidden');
      timeSlotsGrid.classList.add('hidden');
      timeSlotsError.classList.add('hidden');
      selectedSlotIndicator.classList.add('hidden');

      try {
        const response = await fetch('/api/check-availability', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ date: date.toISOString().split('T')[0] }),
        });

        const data = await response.json();

        timeSlotsSpinner.classList.add('hidden');

        if (!response.ok || data.availableSlots.length === 0) {
          timeSlotsError.classList.remove('hidden');
          return;
        }

        // Populate time slots
        timeSlotsGrid.innerHTML = '';
        data.availableSlots.forEach((slot: string) => {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'px-4 py-3 border-2 border-base-300 rounded-lg hover:border-[#0052cc] hover:bg-blue-50 transition-all text-sm font-medium';
          button.textContent = slot;

          button.addEventListener('click', () => selectTimeSlot(slot, button));
          timeSlotsGrid.appendChild(button);
        });

        timeSlotsGrid.classList.remove('hidden');
      } catch (error) {
        console.error('Error fetching slots:', error);
        timeSlotsSpinner.classList.add('hidden');
        timeSlotsError.classList.remove('hidden');
        timeSlotsError.textContent = 'Error al verificar disponibilidad. Inténtalo de nuevo.';
      }
    }

    function selectTimeSlot(time: string, button: HTMLButtonElement) {
      // Remove previous selection
      timeSlotsGrid.querySelectorAll('button').forEach(btn => {
        btn.className = 'px-4 py-3 border-2 border-base-300 rounded-lg hover:border-[#0052cc] hover:bg-blue-50 transition-all text-sm font-medium';
      });

      // Add selection
      button.className = 'px-4 py-3 border-2 border-[#0052cc] bg-blue-50 rounded-lg text-[#0052cc] font-semibold';
      selectedTime = time;
      selectedTimeInput.value = time;

      // Update indicator
      if (selectedDate) {
        const dateStr = `${selectedDate.getDate()} de ${monthNames[selectedDate.getMonth()]}`;
        selectedSlotText.textContent = `Reunión: ${dateStr} a las ${time}h`;
        selectedSlotIndicator.classList.remove('hidden');
      }
    }

    prevMonthBtn.addEventListener('click', () => {
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      generateCalendar();
    });

    nextMonthBtn.addEventListener('click', () => {
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      generateCalendar();
    });

    function showAlert(message: string, type: 'success' | 'error') {
      alertContainer.className = `max-w-5xl mx-auto mb-6 p-4 rounded-lg ${
        type === 'success'
          ? 'bg-green-50 border border-green-200 text-green-800'
          : 'bg-red-50 border border-red-200 text-red-800'
      }`;
      alertContainer.innerHTML = message;
      alertContainer.classList.remove('hidden');
      alertContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function setLoading(loading: boolean) {
      submitButton.disabled = loading;
      if (loading) {
        buttonText.classList.add('hidden');
        buttonLoading.classList.remove('hidden');
      } else {
        buttonText.classList.remove('hidden');
        buttonLoading.classList.add('hidden');
      }
    }

    meetingForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!selectedDate || !selectedTime) {
        showAlert('⚠️ Por favor selecciona una fecha y hora para la reunión', 'error');
        return;
      }

      setLoading(true);
      alertContainer.classList.add('hidden');

      try {
        const formData = new FormData(meetingForm);
        const response = await fetch('/api/send-meeting-request', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (response.ok) {
          meetingForm.classList.add('hidden');
          bookingSuccess.classList.remove('hidden');

          // Show confirmed date and time
          if (selectedDate && selectedTime) {
            const dateStr = `${selectedDate.getDate()} de ${monthNames[selectedDate.getMonth()]} de ${selectedDate.getFullYear()}`;
            confirmedDateTime.textContent = `${dateStr} a las ${selectedTime}h (2 horas)`;
          }

          // Scroll to success message
          bookingSuccess.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
          showAlert(data.error || 'Ha ocurrido un error. Por favor, inténtalo de nuevo.', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showAlert('Error de conexión. Por favor, verifica tu conexión e inténtalo de nuevo.', 'error');
      } finally {
        setLoading(false);
      }
    });

    generateCalendar();
  });
</script>
