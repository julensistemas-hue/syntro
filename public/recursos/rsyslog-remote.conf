# ============================================
# RSYSLOG - Configuracion para recibir logs remotos
# Curso Intensivo de Wazuh - AI Security
#
# Este archivo configura rsyslog para actuar como
# servidor syslog y recibir logs de dispositivos
# de red (NAS, routers, firewalls, etc.)
#
# Copiar a: /etc/rsyslog.d/10-remote.conf
# Reiniciar: sudo systemctl restart rsyslog
# ============================================

# ============================================
# MODULOS PARA RECIBIR LOGS REMOTOS
# ============================================

# Habilitar recepcion por UDP (puerto 514)
# Mas rapido, pero sin garantia de entrega
module(load="imudp")
input(type="imudp" port="514")

# Habilitar recepcion por TCP (puerto 514)
# Mas fiable, con garantia de entrega
module(load="imtcp")
input(type="imtcp" port="514")

# ============================================
# PLANTILLA PARA GUARDAR LOGS
# ============================================

# Guardar logs remotos organizados por hostname y programa
# Estructura: /var/log/remote/[hostname]/[programa].log
$template RemoteLogs,"/var/log/remote/%HOSTNAME%/%PROGRAMNAME%.log"

# Plantilla alternativa: todo en un archivo por host
# $template RemoteLogsSimple,"/var/log/remote/%HOSTNAME%.log"

# ============================================
# REGLAS DE ALMACENAMIENTO
# ============================================

# Guardar TODOS los logs remotos usando la plantilla
# El & indica que es una accion adicional, no reemplaza
if $fromhost-ip != "127.0.0.1" then ?RemoteLogs
& stop

# ============================================
# CONFIGURACION ALTERNATIVA POR TIPO
# ============================================

# Si quieres separar por tipo de dispositivo:
#
# NAS Synology (ejemplo)
# if $fromhost-ip == "192.168.1.50" then /var/log/remote/nas-synology.log
# & stop
#
# Router/Firewall
# if $fromhost-ip == "192.168.1.1" then /var/log/remote/router.log
# & stop
#
# Switches
# if $fromhost-ip startswith "192.168.1.10" then /var/log/remote/switches.log
# & stop

# ============================================
# ROTACION DE LOGS
# ============================================
# Crear archivo /etc/logrotate.d/remote-logs con:
#
# /var/log/remote/*/*.log {
#     daily
#     rotate 30
#     compress
#     delaycompress
#     missingok
#     notifempty
#     create 640 syslog adm
# }

# ============================================
# SEGURIDAD
# ============================================

# Limitar IPs que pueden enviar logs (opcional)
# Descomentar y ajustar segun tu red

# $AllowedSender UDP, 192.168.1.0/24
# $AllowedSender TCP, 192.168.1.0/24

# ============================================
# VERIFICAR FUNCIONAMIENTO
# ============================================
#
# 1. Ver si rsyslog escucha:
#    sudo ss -ulnp | grep 514
#    sudo ss -tlnp | grep 514
#
# 2. Probar envio desde otro equipo:
#    logger -n IP_SERVIDOR -P 514 "Test message"
#
# 3. Ver logs recibidos:
#    tail -f /var/log/remote/*/*.log
#
# ============================================
